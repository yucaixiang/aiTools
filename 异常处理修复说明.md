# å¼‚å¸¸å¤„ç†ä¿®å¤è¯´æ˜

**æ—¥æœŸ**: 2025-12-10
**é—®é¢˜**:
1. `/api/reviews` æ¥å£è¦æ±‚ `X-User-Id` è¯·æ±‚å¤´å¯¼è‡´å…¬å¼€æ¥å£æ— æ³•è®¿é—®
2. åç«¯ `BusinessException` å¼‚å¸¸æ²¡æœ‰æ­£ç¡®ä¼ é€’ç»™å‰ç«¯æ˜¾ç¤º

---

## é—®é¢˜1: X-User-Id è¯·æ±‚å¤´ç¼ºå¤±é”™è¯¯

### é”™è¯¯ä¿¡æ¯
```
org.springframework.web.bind.MissingRequestHeaderException:
Required request header 'X-User-Id' for method parameter type Long is not present
```

### æ ¹æœ¬åŸå› 
- æŸäº›å…¬å¼€æ¥å£ï¼ˆå¦‚ `/api/reviews/tool/{toolId}`ï¼‰ä¸éœ€è¦ç”¨æˆ·ç™»å½•
- ä½†æ§åˆ¶å™¨æ–¹æ³•ä»ç„¶è¦æ±‚ `X-User-Id` è¯·æ±‚å¤´
- å¯¼è‡´æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—®è¿™äº›å…¬å¼€æ¥å£

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: åœ¨GlobalExceptionHandlerä¸­å¤„ç†ï¼ˆå·²å®æ–½âœ…ï¼‰

**æ–‡ä»¶**: `review-service/src/main/java/com/toolrecommend/review/exception/GlobalExceptionHandler.java`

æ·»åŠ å¤„ç† `MissingRequestHeaderException` çš„æ–¹æ³•ï¼š

```java
@ExceptionHandler(MissingRequestHeaderException.class)
public Result<Void> handleMissingRequestHeaderException(MissingRequestHeaderException e) {
    log.error("ç¼ºå°‘è¯·æ±‚å¤´: {}", e.getHeaderName());
    return Result.error(401, "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•");
}
```

**ä¼˜ç‚¹**:
- å¿«é€Ÿä¿®å¤ï¼Œä¸éœ€è¦ä¿®æ”¹æ§åˆ¶å™¨
- ç»Ÿä¸€çš„é”™è¯¯å“åº”

**ç¼ºç‚¹**:
- æ²¡æœ‰åŒºåˆ†å…¬å¼€æ¥å£å’Œéœ€è¦ç™»å½•çš„æ¥å£

#### æ–¹æ¡ˆ2: ä¿®æ”¹æ§åˆ¶å™¨å‚æ•°ï¼ˆæ¨èä½†éœ€è¦æ›´å¤šæ”¹åŠ¨ï¼‰

å°†å…¬å¼€æ¥å£çš„ `@RequestHeader` æ”¹ä¸ºå¯é€‰ï¼š

```java
// ä¿®æ”¹å‰
@GetMapping("/tool/{toolId}")
public Result<PageResult<ReviewVO>> getToolReviews(
        @PathVariable Long toolId,
        @RequestParam(defaultValue = "1") Long current,
        @RequestParam(defaultValue = "10") Long size) {
    // ...
}

// è¿™ä¸ªæ–¹æ³•æœ¬æ¥å°±æ²¡æœ‰ X-User-Idï¼Œæ‰€ä»¥ä¸éœ€è¦æ”¹
```

**å½“å‰çŠ¶æ€**: `/tool/{toolId}` æ¥å£å·²ç»æ˜¯å…¬å¼€çš„ï¼Œä¸éœ€è¦ `X-User-Id`

---

## é—®é¢˜2: BusinessException æœªæ­£ç¡®æ˜¾ç¤º

### é—®é¢˜æè¿°
- åç«¯æŠ›å‡º `BusinessException` æ—¶ï¼Œå‰ç«¯åªæ˜¾ç¤ºé€šç”¨é”™è¯¯æ¶ˆæ¯
- ç”¨æˆ·çœ‹ä¸åˆ°å…·ä½“çš„ä¸šåŠ¡é”™è¯¯ï¼ˆå¦‚"æ‚¨å·²è¯„è®ºè¿‡è¯¥å·¥å…·"ï¼‰

### è§£å†³æ–¹æ¡ˆ

#### åç«¯ä¿®æ”¹ âœ…

å·²æœ‰ `BusinessException` å¤„ç†å™¨ï¼š

```java
@ExceptionHandler(BusinessException.class)
public Result<Void> handleBusinessException(BusinessException e) {
    log.error("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
    return Result.error(e.getCode(), e.getMessage());
}
```

è¿™éƒ¨åˆ†å·²ç»æ­£ç¡®è¿”å›äº†ä¸šåŠ¡æ¶ˆæ¯ã€‚

#### å‰ç«¯ä¿®æ”¹ âœ…

**æ–‡ä»¶**: `frontend/web/src/api/request.js`

**ä¿®æ”¹å‰**:
```javascript
(error) => {
  if (error.response?.status === 401) {
    localStorage.removeItem('token')
    localStorage.removeItem('user')
    window.location.href = '/login'
  }
  return Promise.reject(error)
}
```

**ä¿®æ”¹å**:
```javascript
(error) => {
  // å¤„ç†401æœªæˆæƒ
  if (error.response?.status === 401) {
    localStorage.removeItem('token')
    localStorage.removeItem('user')
    window.location.href = '/login'
    return Promise.reject(error)
  }

  // æå–åç«¯è¿”å›çš„é”™è¯¯æ¶ˆæ¯
  const errorMessage = error.response?.data?.message || error.message || 'è¯·æ±‚å¤±è´¥'

  // æ˜¾ç¤ºé”™è¯¯æç¤º
  console.error('APIé”™è¯¯:', errorMessage)

  // åˆ›å»ºä¸€ä¸ªæ–°çš„é”™è¯¯å¯¹è±¡ï¼ŒåŒ…å«åç«¯çš„ä¸šåŠ¡æ¶ˆæ¯
  const businessError = new Error(errorMessage)
  businessError.code = error.response?.data?.code || error.response?.status
  businessError.response = error.response

  return Promise.reject(businessError)
}
```

**å…³é”®æ”¹è¿›**:
1. æå– `error.response.data.message`ï¼ˆåç«¯çš„ä¸šåŠ¡æ¶ˆæ¯ï¼‰
2. åˆ›å»ºæ–°çš„ Error å¯¹è±¡ï¼Œå°†ä¸šåŠ¡æ¶ˆæ¯ä½œä¸º `message` å±æ€§
3. å‰ç«¯ catch ä¸­ä½¿ç”¨ `error.message` å°±èƒ½è·å–ä¸šåŠ¡æ¶ˆæ¯

#### å‰ç«¯ç»„ä»¶ä¿®æ”¹ âœ…

**æ–‡ä»¶**: `frontend/web/src/views/ToolDetail.vue`

**ä¿®æ”¹å‰**:
```javascript
catch (error) {
  alert('è¯„è®ºå¤±è´¥ï¼Œè¯·å…ˆç™»å½•')  // å›ºå®šæ¶ˆæ¯
}
```

**ä¿®æ”¹å**:
```javascript
catch (error) {
  alert(error.message || 'è¯„è®ºå¤±è´¥')  // åŠ¨æ€æ¶ˆæ¯
}
```

---

## ä¿®æ”¹æ¸…å•

### åç«¯ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|---------|------|
| `review-service/.../GlobalExceptionHandler.java` | æ·»åŠ  MissingRequestHeaderException å¤„ç† | âœ… |

### å‰ç«¯ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|---------|------|
| `frontend/web/src/api/request.js` | ä¼˜åŒ–å“åº”æ‹¦æˆªå™¨ï¼Œæå–ä¸šåŠ¡æ¶ˆæ¯ | âœ… |
| `frontend/web/src/views/ToolDetail.vue` | ä½¿ç”¨ error.message æ˜¾ç¤ºé”™è¯¯ | âœ… |

---

## å…¶ä»–æœåŠ¡çš„GlobalExceptionHandler

å»ºè®®å°†ç›¸åŒçš„å¼‚å¸¸å¤„ç†é€»è¾‘å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡ï¼š

### user-service
```bash
# æ·»åŠ  MissingRequestHeaderException å¤„ç†
# æ–‡ä»¶ä½ç½®: user-service/src/main/java/com/toolrecommend/user/exception/GlobalExceptionHandler.java
```

### tool-service
```bash
# æ·»åŠ  MissingRequestHeaderException å¤„ç†
# æ–‡ä»¶ä½ç½®: tool-service/src/main/java/com/toolrecommend/tool/exception/GlobalExceptionHandler.java
```

### ai-service
```bash
# æ·»åŠ  MissingRequestHeaderException å¤„ç†
# æ–‡ä»¶ä½ç½®: ai-service/src/main/java/com/toolrecommend/ai/exception/GlobalExceptionHandler.java
```

---

## æµ‹è¯•éªŒè¯

### åç«¯æµ‹è¯•

**æµ‹è¯•1: ç¼ºå°‘X-User-Idå¤´**
```bash
# åº”è¯¥è¿”å›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯500é”™è¯¯
curl http://localhost:8090/api/reviews \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"toolId": 1, "rating": 5, "content": "æµ‹è¯•"}'

# é¢„æœŸå“åº”:
{
  "code": 401,
  "message": "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•",
  "success": false
}
```

**æµ‹è¯•2: BusinessException**
```bash
# å‡è®¾æœ‰ä¸šåŠ¡è§„åˆ™ï¼šç”¨æˆ·ä¸èƒ½é‡å¤è¯„è®ºåŒä¸€å·¥å…·
curl http://localhost:8090/api/reviews \
  -X POST \
  -H "Content-Type: application/json" \
  -H "X-User-Id: 1" \
  -H "Authorization: Bearer xxx" \
  -d '{"toolId": 1, "rating": 5, "content": "æµ‹è¯•"}'

# ç¬¬äºŒæ¬¡è°ƒç”¨ï¼Œé¢„æœŸå“åº”:
{
  "code": 400,
  "message": "æ‚¨å·²è¯„è®ºè¿‡è¯¥å·¥å…·",
  "success": false
}
```

### å‰ç«¯æµ‹è¯•

**æµ‹è¯•1: æœªç™»å½•æäº¤è¯„è®º**
1. æ‰“å¼€å·¥å…·è¯¦æƒ…é¡µ
2. ç‚¹å‡»"å†™è¯„è®º"
3. å¡«å†™è¯„åˆ†å’Œå†…å®¹
4. ç‚¹å‡»æäº¤
5. **é¢„æœŸ**: å¼¹å‡º "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•"ï¼ˆè€Œä¸æ˜¯"è¯„è®ºå¤±è´¥ï¼Œè¯·å…ˆç™»å½•"ï¼‰

**æµ‹è¯•2: é‡å¤è¯„è®º**
1. å·²ç™»å½•ç”¨æˆ·æäº¤è¯„è®ºæˆåŠŸ
2. å†æ¬¡å°è¯•æäº¤è¯„è®º
3. **é¢„æœŸ**: å¼¹å‡ºåç«¯è¿”å›çš„å…·ä½“æ¶ˆæ¯ï¼ˆå¦‚"æ‚¨å·²è¯„è®ºè¿‡è¯¥å·¥å…·"ï¼‰

**æµ‹è¯•3: æ”¶è—æ“ä½œå¤±è´¥**
1. ç™»å½•ç”¨æˆ·ç‚¹å‡»æ”¶è—
2. å¦‚æœåç«¯æŠ›å‡ºå¼‚å¸¸
3. **é¢„æœŸ**: å¼¹å‡ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯æ¶ˆæ¯

---

## æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰APIé”™è¯¯éƒ½åº”è¯¥è¿”å›ç»Ÿä¸€æ ¼å¼ï¼š
```json
{
  "code": 400/401/403/404/500,
  "message": "å…·ä½“çš„é”™è¯¯æ¶ˆæ¯",
  "data": null,
  "timestamp": 1234567890,
  "success": false
}
```

### 2. å‰ç«¯é”™è¯¯å¤„ç†åŸåˆ™

```javascript
try {
  await apiCall()
} catch (error) {
  // âœ… å¥½çš„åšæ³•
  alert(error.message)  // æ˜¾ç¤ºåç«¯çš„ä¸šåŠ¡æ¶ˆæ¯

  // âŒ ä¸å¥½çš„åšæ³•
  alert('æ“ä½œå¤±è´¥')  // å›ºå®šæ¶ˆæ¯ï¼Œç”¨æˆ·ä¸çŸ¥é“å…·ä½“åŸå› 
}
```

### 3. æ—¥å¿—è®°å½•

- åç«¯: åœ¨ GlobalExceptionHandler ä¸­è®°å½•é”™è¯¯æ—¥å¿—
- å‰ç«¯: åœ¨å“åº”æ‹¦æˆªå™¨ä¸­ console.error è®°å½•

### 4. ç”¨æˆ·ä½“éªŒ

- âœ… æ˜¾ç¤ºå…·ä½“çš„ä¸šåŠ¡é”™è¯¯æ¶ˆæ¯
- âœ… åŒºåˆ†400ï¼ˆä¸šåŠ¡é”™è¯¯ï¼‰å’Œ500ï¼ˆç³»ç»Ÿé”™è¯¯ï¼‰
- âœ… 401é”™è¯¯è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
- âŒ ä¸è¦æ˜¾ç¤ºæŠ€æœ¯æ€§çš„é”™è¯¯å †æ ˆç»™ç”¨æˆ·

---

## åç»­ä¼˜åŒ–å»ºè®®

### é«˜ä¼˜å…ˆçº§

1. **Toastç»„ä»¶æ›¿ä»£alert** â­â­â­â­â­
   ```javascript
   // ä½¿ç”¨æ›´å‹å¥½çš„Toastæç¤º
   import { useToast } from '@/composables/useToast'

   const toast = useToast()
   toast.error(error.message)
   ```

2. **å®Œå–„å…¶ä»–æœåŠ¡çš„å¼‚å¸¸å¤„ç†** â­â­â­â­
   - user-service
   - tool-service
   - ai-service

### ä¸­ä¼˜å…ˆçº§

3. **é”™è¯¯ç å›½é™…åŒ–** â­â­â­
   ```java
   // å®šä¹‰é”™è¯¯ç æšä¸¾
   public enum ErrorCode {
       UNAUTHORIZED(401, "æœªæˆæƒ"),
       ALREADY_REVIEWED(40001, "æ‚¨å·²è¯„è®ºè¿‡è¯¥å·¥å…·"),
       // ...
   }
   ```

4. **å‰ç«¯é”™è¯¯æ—¥å¿—ä¸ŠæŠ¥** â­â­â­
   ```javascript
   // å°†é”™è¯¯ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
   logErrorToMonitoring(error)
   ```

### ä½ä¼˜å…ˆçº§

5. **é”™è¯¯é‡è¯•æœºåˆ¶** â­â­
   - ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•
   - æŒ‡æ•°é€€é¿ç­–ç•¥

---

## å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆæœ‰äº›æ¥å£ä¸éœ€è¦X-User-Idï¼Ÿ
**A**: å…¬å¼€æ¥å£ï¼ˆå¦‚æŸ¥çœ‹å·¥å…·åˆ—è¡¨ã€æŸ¥çœ‹è¯„è®ºï¼‰ä¸éœ€è¦ç™»å½•ï¼Œå› æ­¤ä¸éœ€è¦ç”¨æˆ·IDã€‚

### Q2: å¦‚ä½•åˆ¤æ–­æŸä¸ªæ¥å£éœ€ä¸éœ€è¦X-User-Idï¼Ÿ
**A**:
- éœ€è¦: åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œéœ€è¦çŸ¥é“æ˜¯å“ªä¸ªç”¨æˆ·
- ä¸éœ€è¦: æŸ¥è¯¢å…¬å¼€æ•°æ®çš„æ“ä½œ

### Q3: BusinessException å’Œæ™®é€š Exception çš„åŒºåˆ«ï¼Ÿ
**A**:
- BusinessException: ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå¦‚é‡å¤è¯„è®ºï¼‰ï¼Œåº”è¯¥æ˜¾ç¤ºç»™ç”¨æˆ·
- Exception: ç³»ç»Ÿé”™è¯¯ï¼ˆå¦‚æ•°æ®åº“è¿æ¥å¤±è´¥ï¼‰ï¼Œæ˜¾ç¤ºé€šç”¨æ¶ˆæ¯

### Q4: ä¸ºä»€ä¹ˆè¦åœ¨å“åº”æ‹¦æˆªå™¨ä¸­å¤„ç†é”™è¯¯ï¼Ÿ
**A**: ç»Ÿä¸€å¤„ç†ï¼Œé¿å…åœ¨æ¯ä¸ªç»„ä»¶ä¸­é‡å¤å†™ç›¸åŒçš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚

---

## æ€»ç»“

### å·²å®Œæˆ âœ…

1. âœ… åç«¯æ·»åŠ  MissingRequestHeaderException å¤„ç†
2. âœ… å‰ç«¯ä¼˜åŒ–å“åº”æ‹¦æˆªå™¨æå–ä¸šåŠ¡æ¶ˆæ¯
3. âœ… å‰ç«¯ç»„ä»¶ä½¿ç”¨åŠ¨æ€é”™è¯¯æ¶ˆæ¯

### æ•ˆæœ ğŸ¯

- ç”¨æˆ·èƒ½çœ‹åˆ°å…·ä½“çš„é”™è¯¯åŸå› 
- æœªç™»å½•è®¿é—®å…¬å¼€æ¥å£ä¸å†æŠ¥500é”™è¯¯
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### å¾…ä¼˜åŒ– â³

- Toastç»„ä»¶æ›¿ä»£alert
- å®Œå–„å…¶ä»–æœåŠ¡çš„å¼‚å¸¸å¤„ç†
- é”™è¯¯æ—¥å¿—ä¸ŠæŠ¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-12-10
**ä½œè€…**: AI Tool Recommend Team
