# AI工具推荐系统 - 数据库设计文档

## 文档信息
- **项目名称**：智能工具推荐平台
- **版本**：v1.0
- **创建日期**：2025-12-04
- **数据库版本**：MySQL 8.0

---

## 一、数据库设计原则

### 1.1 设计规范
- **命名规范**：
  - 表名：小写字母+下划线，如`user_action`
  - 字段名：小写字母+下划线，如`created_at`
  - 索引名：`idx_`前缀，如`idx_user_id`
  - 唯一索引：`uk_`前缀，如`uk_email`

- **字段规范**：
  - 主键统一使用`id` BIGINT AUTO_INCREMENT
  - 创建时间：`created_at` TIMESTAMP
  - 更新时间：`updated_at` TIMESTAMP
  - 软删除：`is_deleted` TINYINT (0-未删除, 1-已删除)
  - 状态字段：`status` TINYINT

- **性能规范**：
  - 合理建立索引，覆盖常用查询
  - 避免使用TEXT/BLOB，改用VARCHAR或存储路径
  - 数值类型优先使用TINYINT、INT，避免BIGINT滥用
  - 时间类型使用TIMESTAMP，支持自动更新

### 1.2 数据库选型
- **主数据库**：MySQL 8.0（ACID事务支持）
- **缓存**：Redis 7（高性能KV存储）
- **搜索**：Elasticsearch 8（全文检索）
- **向量库**：Qdrant（语义搜索）

---

## 二、ER关系图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│    user     │──┬───→│user_action  │←──────│    tool     │
│  用户表      │  │    │用户行为表    │       │  工具表      │
└─────────────┘  │    └─────────────┘       └─────────────┘
                 │                                ↑  ↑  ↑
                 │                                │  │  │
                 │    ┌─────────────┐            │  │  │
                 └───→│   review    │────────────┘  │  │
                      │  评论表      │               │  │
                      └─────────────┘               │  │
                                                     │  │
        ┌─────────────┐       ┌─────────────┐      │  │
        │  category   │←──────│  tool_tag   │──────┘  │
        │  分类表      │       │工具标签关联  │          │
        └─────────────┘       └─────────────┘          │
                                     ↑                 │
                                     │                 │
                              ┌─────────────┐          │
                              │     tag     │          │
                              │   标签表     │          │
                              └─────────────┘          │
                                                        │
        ┌─────────────┐                                │
        │conversation │                                │
        │  对话表      │                                │
        └─────────────┘                                │
                                                        │
        ┌─────────────┐       ┌─────────────┐         │
        │tool_feature │───────│tool_alternative│───────┘
        │工具特性表    │       │工具替代关系表    │
        └─────────────┘       └─────────────┘
```

---

## 三、核心表设计

### 3.1 tool（工具表）

**表描述**：存储工具的基本信息和元数据

```sql
CREATE TABLE `tool` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '工具ID',
  `name` VARCHAR(200) NOT NULL COMMENT '工具名称',
  `slug` VARCHAR(200) UNIQUE NOT NULL COMMENT 'URL友好标识，如notion',
  `tagline` VARCHAR(500) COMMENT '一句话介绍',
  `description` TEXT COMMENT '详细描述（支持Markdown）',
  `logo_url` VARCHAR(500) COMMENT 'Logo图片地址',
  `website_url` VARCHAR(500) COMMENT '官网地址',
  `download_url` VARCHAR(500) COMMENT '下载地址',
  `github_url` VARCHAR(500) COMMENT 'GitHub地址',
  `category_id` INT NOT NULL COMMENT '主分类ID',
  `pricing_model` ENUM('FREE', 'FREEMIUM', 'PAID', 'OPEN_SOURCE')
    DEFAULT 'FREE' COMMENT '定价模式',
  `starting_price` DECIMAL(10,2) COMMENT '起始价格（USD）',
  `launch_date` DATE COMMENT '发布日期',
  `maker_id` BIGINT COMMENT '提交者/创建者ID',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-草稿 1-已发布 2-已下架 3-待审核',
  `view_count` INT DEFAULT 0 COMMENT '浏览量',
  `favorite_count` INT DEFAULT 0 COMMENT '收藏数',
  `upvote_count` INT DEFAULT 0 COMMENT '点赞数',
  `review_count` INT DEFAULT 0 COMMENT '评论数',
  `average_rating` DECIMAL(3,2) DEFAULT 0.00 COMMENT '平均评分（1-5分）',
  `profile_completeness` DECIMAL(3,2) DEFAULT 0.00 COMMENT '信息完整度（0-1）',
  `monthly_growth_rate` DECIMAL(5,4) DEFAULT 0.0000 COMMENT '月增长率',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

  INDEX `idx_category_status` (`category_id`, `status`),
  INDEX `idx_status_launch` (`status`, `launch_date` DESC),
  INDEX `idx_maker` (`maker_id`),
  INDEX `idx_rating` (`average_rating` DESC, `review_count` DESC),
  INDEX `idx_popular` (`status`, `view_count` DESC),
  FULLTEXT INDEX `ft_search` (`name`, `tagline`, `description`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='工具信息表';
```

**字段说明**：
- `slug`：用于生成友好URL，如 `/tools/notion`
- `pricing_model`：定价模式，便于筛选免费/付费工具
- `profile_completeness`：信息完整度，影响推荐排序
- `monthly_growth_rate`：月增长率，用于计算趋势

### 3.2 category（分类表）

**表描述**：工具分类，支持多级分类

```sql
CREATE TABLE `category` (
  `id` INT PRIMARY KEY AUTO_INCREMENT COMMENT '分类ID',
  `name` VARCHAR(100) NOT NULL COMMENT '分类名称',
  `slug` VARCHAR(100) UNIQUE NOT NULL COMMENT 'URL标识',
  `parent_id` INT DEFAULT NULL COMMENT '父分类ID，NULL表示顶级分类',
  `icon` VARCHAR(200) COMMENT '图标URL或图标名',
  `description` VARCHAR(500) COMMENT '分类描述',
  `sort_order` INT DEFAULT 0 COMMENT '排序权重，数字越大越靠前',
  `tool_count` INT DEFAULT 0 COMMENT '工具数量（冗余字段，定期更新）',
  `is_active` TINYINT DEFAULT 1 COMMENT '是否启用：0-禁用 1-启用',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX `idx_parent` (`parent_id`, `sort_order` DESC),
  INDEX `idx_active` (`is_active`, `sort_order` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='分类表';
```

**示例数据**：
```sql
INSERT INTO category (name, slug, parent_id, icon, sort_order) VALUES
('开发工具', 'developer-tools', NULL, 'icon-code', 100),
('代码编辑器', 'code-editors', 1, 'icon-editor', 10),
('设计工具', 'design-tools', NULL, 'icon-design', 90),
('UI设计', 'ui-design', 3, 'icon-ui', 10),
('生产力工具', 'productivity', NULL, 'icon-productivity', 80);
```

### 3.3 tag（标签表）

**表描述**：工具标签，用于多维度分类和搜索

```sql
CREATE TABLE `tag` (
  `id` INT PRIMARY KEY AUTO_INCREMENT COMMENT '标签ID',
  `name` VARCHAR(50) NOT NULL UNIQUE COMMENT '标签名称',
  `slug` VARCHAR(50) UNIQUE NOT NULL COMMENT 'URL标识',
  `usage_count` INT DEFAULT 0 COMMENT '使用次数',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX `idx_usage` (`usage_count` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='标签表';
```

**示例数据**：
```sql
INSERT INTO tag (name, slug) VALUES
('人工智能', 'ai'),
('开源', 'open-source'),
('免费', 'free'),
('跨平台', 'cross-platform'),
('团队协作', 'collaboration');
```

### 3.4 tool_tag（工具标签关联表）

**表描述**：工具与标签的多对多关系

```sql
CREATE TABLE `tool_tag` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tool_id` BIGINT NOT NULL COMMENT '工具ID',
  `tag_id` INT NOT NULL COMMENT '标签ID',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  UNIQUE KEY `uk_tool_tag` (`tool_id`, `tag_id`),
  INDEX `idx_tag` (`tag_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工具标签关联表';
```

### 3.5 user（用户表）

**表描述**：用户基本信息和认证数据

```sql
CREATE TABLE `user` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
  `email` VARCHAR(100) UNIQUE COMMENT '邮箱',
  `phone` VARCHAR(20) UNIQUE COMMENT '手机号',
  `password_hash` VARCHAR(255) NOT NULL COMMENT '密码哈希（BCrypt）',
  `avatar_url` VARCHAR(500) COMMENT '头像URL',
  `nickname` VARCHAR(50) COMMENT '昵称',
  `bio` VARCHAR(500) COMMENT '个人简介',
  `role` ENUM('USER', 'MAKER', 'ADMIN', 'SUPER_ADMIN')
    DEFAULT 'USER' COMMENT '用户角色',
  `status` TINYINT DEFAULT 1 COMMENT '账号状态：0-禁用 1-正常 2-锁定',
  `last_login_at` TIMESTAMP COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(50) COMMENT '最后登录IP',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX `idx_email` (`email`),
  INDEX `idx_phone` (`phone`),
  INDEX `idx_status` (`status`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

### 3.6 user_action（用户行为表）

**表描述**：记录用户对工具的操作行为

```sql
CREATE TABLE `user_action` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `tool_id` BIGINT NOT NULL COMMENT '工具ID',
  `action_type` ENUM('VIEW', 'UPVOTE', 'FAVORITE', 'CLICK_WEBSITE', 'CLICK_DOWNLOAD')
    NOT NULL COMMENT '行为类型',
  `action_value` VARCHAR(200) COMMENT '行为值（如点击的链接）',
  `source` VARCHAR(50) COMMENT '来源：search/recommend/ranking/detail',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX `idx_user_tool` (`user_id`, `tool_id`, `action_type`),
  INDEX `idx_tool_action` (`tool_id`, `action_type`, `created_at` DESC),
  INDEX `idx_user_time` (`user_id`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户行为表';

-- 分表建议：按user_id取模分16表，单表数据量控制在千万级别
-- user_action_0, user_action_1, ..., user_action_15
```

**行为类型说明**：
- `VIEW`：浏览工具详情
- `UPVOTE`：点赞工具
- `FAVORITE`：收藏工具
- `CLICK_WEBSITE`：点击官网链接
- `CLICK_DOWNLOAD`：点击下载链接

### 3.7 review（评论表）

**表描述**：用户对工具的评分和评论

```sql
CREATE TABLE `review` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tool_id` BIGINT NOT NULL COMMENT '工具ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `rating` TINYINT NOT NULL COMMENT '评分：1-5星',
  `title` VARCHAR(200) COMMENT '评论标题',
  `content` TEXT NOT NULL COMMENT '评论内容',
  `pros` JSON COMMENT '优点列表 ["优点1", "优点2"]',
  `cons` JSON COMMENT '缺点列表',
  `usage_duration` ENUM('WEEK', 'MONTH', 'QUARTER', 'HALF_YEAR', 'YEAR')
    COMMENT '使用时长',
  `usage_scenario` VARCHAR(100) COMMENT '使用场景',
  `helpful_count` INT DEFAULT 0 COMMENT '有帮助数',
  `reply_count` INT DEFAULT 0 COMMENT '回复数',
  `is_verified` TINYINT DEFAULT 0 COMMENT '是否验证使用：0-否 1-是',
  `is_featured` TINYINT DEFAULT 0 COMMENT '是否精选：0-否 1-是',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-已删除 1-正常 2-待审核 3-已举报',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY `uk_tool_user` (`tool_id`, `user_id`),
  INDEX `idx_tool_status` (`tool_id`, `status`, `created_at` DESC),
  INDEX `idx_user` (`user_id`, `created_at` DESC),
  INDEX `idx_rating` (`rating`, `helpful_count` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论表';
```

**示例JSON数据**：
```json
{
  "pros": ["界面简洁", "功能强大", "性价比高"],
  "cons": ["上手门槛高", "移动端体验一般"]
}
```

### 3.8 review_reply（评论回复表）

**表描述**：对评论的回复

```sql
CREATE TABLE `review_reply` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `review_id` BIGINT NOT NULL COMMENT '评论ID',
  `user_id` BIGINT NOT NULL COMMENT '回复者ID',
  `parent_id` BIGINT COMMENT '父回复ID（楼中楼）',
  `content` TEXT NOT NULL COMMENT '回复内容',
  `is_author` TINYINT DEFAULT 0 COMMENT '是否工具作者回复',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-已删除 1-正常',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX `idx_review` (`review_id`, `created_at` ASC),
  INDEX `idx_parent` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论回复表';
```

### 3.9 tool_feature（工具特性表）

**表描述**：工具的可筛选特性（平台、语言、集成等）

```sql
CREATE TABLE `tool_feature` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tool_id` BIGINT NOT NULL COMMENT '工具ID',
  `feature_type` VARCHAR(50) NOT NULL COMMENT '特性类型：platform/language/integration',
  `feature_name` VARCHAR(100) NOT NULL COMMENT '特性名称',
  `feature_value` VARCHAR(500) COMMENT '特性值',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX `idx_tool` (`tool_id`),
  INDEX `idx_type_name` (`feature_type`, `feature_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工具特性表';
```

**示例数据**：
```sql
INSERT INTO tool_feature (tool_id, feature_type, feature_name, feature_value) VALUES
(1, 'platform', 'Web', NULL),
(1, 'platform', 'iOS', 'iOS 13+'),
(1, 'platform', 'Android', 'Android 8+'),
(1, 'language', 'Chinese', 'zh-CN'),
(1, 'integration', 'Slack', 'https://...'),
(1, 'integration', 'GitHub', 'https://...');
```

### 3.10 tool_alternative（工具替代关系表）

**表描述**：工具之间的替代关系

```sql
CREATE TABLE `tool_alternative` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tool_id` BIGINT NOT NULL COMMENT '主工具ID',
  `alternative_id` BIGINT NOT NULL COMMENT '替代工具ID',
  `similarity_score` DECIMAL(3,2) DEFAULT 0.00 COMMENT '相似度分数（0-1）',
  `user_suggested_count` INT DEFAULT 0 COMMENT '用户建议次数',
  `is_verified` TINYINT DEFAULT 0 COMMENT '是否官方验证',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  UNIQUE KEY `uk_tool_alternative` (`tool_id`, `alternative_id`),
  INDEX `idx_alternative` (`alternative_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工具替代关系表';
```

### 3.11 conversation（AI对话表）

**表描述**：用户与AI的对话记录

```sql
CREATE TABLE `conversation` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `session_id` VARCHAR(100) NOT NULL COMMENT '会话ID（UUID）',
  `user_id` BIGINT COMMENT '用户ID（未登录为NULL）',
  `message` TEXT NOT NULL COMMENT '消息内容',
  `role` ENUM('USER', 'ASSISTANT') NOT NULL COMMENT '角色',
  `recommended_tools` JSON COMMENT '推荐的工具ID列表 [1,2,3]',
  `intent` VARCHAR(100) COMMENT '识别的意图',
  `entities` JSON COMMENT '提取的实体信息',
  `model_used` VARCHAR(50) COMMENT '使用的AI模型',
  `tokens_used` INT COMMENT '消耗的Token数',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX `idx_session` (`session_id`, `created_at` ASC),
  INDEX `idx_user` (`user_id`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI对话表';
```

**示例JSON数据**：
```json
{
  "recommended_tools": [1, 5, 12],
  "entities": {
    "toolType": "笔记工具",
    "platform": ["Web", "iOS"],
    "budget": "免费",
    "features": ["多端同步", "Markdown"]
  }
}
```

### 3.12 conversation_feedback（对话反馈表）

**表描述**：用户对AI推荐的反馈

```sql
CREATE TABLE `conversation_feedback` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `conversation_id` BIGINT NOT NULL COMMENT '对话ID',
  `user_id` BIGINT NOT NULL COMMENT '用户ID',
  `feedback_type` ENUM('THUMBS_UP', 'THUMBS_DOWN', 'CLICK_TOOL', 'IGNORE')
    NOT NULL COMMENT '反馈类型',
  `tool_id` BIGINT COMMENT '点击的工具ID',
  `comment` VARCHAR(500) COMMENT '反馈意见',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX `idx_conversation` (`conversation_id`),
  INDEX `idx_feedback_type` (`feedback_type`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='对话反馈表';
```

### 3.13 ticket（工单表）

**表描述**：用户提交的申请和反馈工单

```sql
CREATE TABLE `ticket` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '提交者ID',
  `tool_id` BIGINT COMMENT '相关工具ID',
  `ticket_type` ENUM('REMOVE_TOOL', 'FIND_ALTERNATIVE', 'USAGE_GUIDE', 'FEEDBACK', 'BUG_REPORT')
    NOT NULL COMMENT '工单类型',
  `title` VARCHAR(200) NOT NULL COMMENT '标题',
  `description` TEXT NOT NULL COMMENT '详细描述',
  `attachments` JSON COMMENT '附件列表 ["url1", "url2"]',
  `status` ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'CLOSED', 'REJECTED')
    DEFAULT 'PENDING' COMMENT '状态',
  `assigned_to` BIGINT COMMENT '分配给（管理员ID）',
  `response` TEXT COMMENT '回复内容',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX `idx_user` (`user_id`, `created_at` DESC),
  INDEX `idx_status` (`status`, `created_at` ASC),
  INDEX `idx_assigned` (`assigned_to`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工单表';
```

### 3.14 notification（通知表）

**表描述**：系统通知和消息

```sql
CREATE TABLE `notification` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT '接收者ID',
  `type` ENUM('SYSTEM', 'REVIEW_REPLY', 'TOOL_UPDATE', 'TICKET_RESPONSE')
    NOT NULL COMMENT '通知类型',
  `title` VARCHAR(200) NOT NULL COMMENT '标题',
  `content` TEXT COMMENT '内容',
  `link_url` VARCHAR(500) COMMENT '跳转链接',
  `is_read` TINYINT DEFAULT 0 COMMENT '是否已读',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX `idx_user_read` (`user_id`, `is_read`, `created_at` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知表';
```

---

## 四、索引设计

### 4.1 索引策略

**1. 主键索引**：所有表的`id`字段自动创建聚簇索引

**2. 唯一索引**：
```sql
-- 用户表
ALTER TABLE user ADD UNIQUE INDEX uk_username (username);
ALTER TABLE user ADD UNIQUE INDEX uk_email (email);
ALTER TABLE user ADD UNIQUE INDEX uk_phone (phone);

-- 工具表
ALTER TABLE tool ADD UNIQUE INDEX uk_slug (slug);

-- 评论表（一个用户对一个工具只能评论一次）
ALTER TABLE review ADD UNIQUE KEY uk_tool_user (tool_id, user_id);
```

**3. 复合索引**：
```sql
-- 工具列表查询（分类+状态+发布时间）
CREATE INDEX idx_tool_list ON tool(category_id, status, launch_date DESC);

-- 用户行为查询
CREATE INDEX idx_user_action_query ON user_action(user_id, tool_id, action_type);

-- 评论列表查询
CREATE INDEX idx_review_list ON review(tool_id, status, created_at DESC);
```

**4. 全文索引**：
```sql
-- 工具搜索
ALTER TABLE tool ADD FULLTEXT INDEX ft_search (name, tagline, description);
```

### 4.2 索引优化原则
- 最左前缀原则：(a, b, c) 可以支持 (a)、(a, b)、(a, b, c) 的查询
- 区分度高的字段放在前面
- 避免冗余索引
- 定期分析慢查询，添加必要索引

---

## 五、数据字典

### 5.1 枚举值说明

**pricing_model（定价模式）**：
- `FREE`：完全免费
- `FREEMIUM`：基础免费+高级付费
- `PAID`：付费软件
- `OPEN_SOURCE`：开源软件

**user.role（用户角色）**：
- `USER`：普通用户
- `MAKER`：工具开发者
- `ADMIN`：管理员
- `SUPER_ADMIN`：超级管理员

**user_action.action_type（行为类型）**：
- `VIEW`：浏览详情
- `UPVOTE`：点赞
- `FAVORITE`：收藏
- `CLICK_WEBSITE`：点击官网
- `CLICK_DOWNLOAD`：点击下载

**ticket.ticket_type（工单类型）**：
- `REMOVE_TOOL`：申请下架工具
- `FIND_ALTERNATIVE`：寻找替代工具
- `USAGE_GUIDE`：申请使用指导
- `FEEDBACK`：反馈建议
- `BUG_REPORT`：Bug报告

**ticket.status（工单状态）**：
- `PENDING`：待处理
- `PROCESSING`：处理中
- `COMPLETED`：已完成
- `CLOSED`：已关闭
- `REJECTED`：已驳回

---

## 六、数据初始化

### 6.1 初始分类数据

```sql
-- 插入主分类
INSERT INTO category (name, slug, icon, sort_order) VALUES
('开发工具', 'developer-tools', 'icon-code', 100),
('设计工具', 'design-tools', 'icon-design', 90),
('生产力工具', 'productivity', 'icon-productivity', 80),
('营销工具', 'marketing', 'icon-marketing', 70),
('AI工具', 'ai-tools', 'icon-ai', 60),
('数据分析', 'analytics', 'icon-chart', 50),
('协作工具', 'collaboration', 'icon-team', 40),
('内容创作', 'content-creation', 'icon-edit', 30);

-- 插入子分类
INSERT INTO category (name, slug, parent_id, icon, sort_order) VALUES
-- 开发工具子分类
('代码编辑器', 'code-editors', 1, 'icon-editor', 10),
('版本控制', 'version-control', 1, 'icon-git', 9),
('API工具', 'api-tools', 1, 'icon-api', 8),
('数据库工具', 'database-tools', 1, 'icon-database', 7),

-- 设计工具子分类
('UI设计', 'ui-design', 2, 'icon-ui', 10),
('原型工具', 'prototyping', 2, 'icon-prototype', 9),
('图标库', 'icon-libraries', 2, 'icon-icons', 8),

-- 生产力工具子分类
('笔记工具', 'note-taking', 3, 'icon-note', 10),
('任务管理', 'task-management', 3, 'icon-task', 9),
('时间管理', 'time-management', 3, 'icon-clock', 8);
```

### 6.2 初始标签数据

```sql
INSERT INTO tag (name, slug) VALUES
-- 特性标签
('免费', 'free'),
('开源', 'open-source'),
('跨平台', 'cross-platform'),
('云服务', 'cloud-based'),
('本地部署', 'self-hosted'),

-- 技术标签
('人工智能', 'ai'),
('机器学习', 'machine-learning'),
('低代码', 'low-code'),
('无代码', 'no-code'),

-- 场景标签
('团队协作', 'collaboration'),
('个人使用', 'personal'),
('企业级', 'enterprise'),
('初学者友好', 'beginner-friendly'),

-- 平台标签
('Web应用', 'web-app'),
('桌面应用', 'desktop-app'),
('移动应用', 'mobile-app'),
('浏览器插件', 'browser-extension');
```

---

## 七、数据备份策略

### 7.1 备份方案

**1. 全量备份**：
- 频率：每天凌晨2:00
- 保留：最近7天
- 工具：mysqldump + 压缩
- 存储：阿里云OSS

**2. 增量备份**：
- 频率：每小时一次
- 保留：最近24小时
- 工具：binlog
- 存储：本地+OSS

**3. 实时备份**：
- 方案：MySQL主从复制
- 配置：1主2从
- 延迟：< 1秒

### 7.2 备份脚本

```bash
#!/bin/bash
# MySQL全量备份脚本

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="tool_recommend"

# 全量备份
mysqldump -h localhost -u backup_user -p${MYSQL_PASSWORD} \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  --databases ${DB_NAME} \
  | gzip > ${BACKUP_DIR}/full_backup_${DATE}.sql.gz

# 上传到OSS
ossutil cp ${BACKUP_DIR}/full_backup_${DATE}.sql.gz \
  oss://tool-recommend-backup/mysql/${DATE}/

# 保留最近7天
find ${BACKUP_DIR} -name "full_backup_*.sql.gz" -mtime +7 -delete

echo "Backup completed: full_backup_${DATE}.sql.gz"
```

---

## 八、性能优化

### 8.1 分库分表

**分表策略**：
```sql
-- user_action表按user_id取模分16表
CREATE TABLE user_action_0 LIKE user_action;
CREATE TABLE user_action_1 LIKE user_action;
...
CREATE TABLE user_action_15 LIKE user_action;

-- 路由规则：user_id % 16 = 表后缀
```

**分库策略**（数据量达到千万级时考虑）：
- 核心业务库：tool、user、review
- 行为数据库：user_action、conversation
- 统计数据库：聚合统计数据

### 8.2 读写分离

```yaml
数据库配置:
  主库 (Master):
    - 处理所有写操作
    - 处理实时性要求高的读操作

  从库1 (Slave1):
    - 处理普通查询

  从库2 (Slave2):
    - 处理数据分析查询
    - 备份数据源
```

### 8.3 慢查询优化

```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1; -- 超过1秒的查询记录

-- 查看慢查询
SELECT * FROM mysql.slow_log
WHERE query_time > '00:00:01'
ORDER BY query_time DESC
LIMIT 10;

-- 分析慢查询
EXPLAIN SELECT * FROM tool
WHERE category_id = 1 AND status = 1
ORDER BY created_at DESC;
```

---

## 九、数据安全

### 9.1 敏感数据加密

```sql
-- 密码加密：使用BCrypt（在应用层处理）
-- 示例：$2a$10$N9qo8uLOickgx2ZMRZoMye...

-- 手机号脱敏显示
SELECT
  id,
  username,
  CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) AS phone_masked
FROM user;

-- 邮箱脱敏显示
SELECT
  id,
  CONCAT(LEFT(email, 2), '***', SUBSTRING_INDEX(email, '@', -1)) AS email_masked
FROM user;
```

### 9.2 数据权限

```sql
-- 创建只读用户
CREATE USER 'readonly'@'%' IDENTIFIED BY 'password';
GRANT SELECT ON tool_recommend.* TO 'readonly'@'%';

-- 创建应用用户（读写权限，无删除权限）
CREATE USER 'app_user'@'%' IDENTIFIED BY 'password';
GRANT SELECT, INSERT, UPDATE ON tool_recommend.* TO 'app_user'@'%';

-- 创建备份用户
CREATE USER 'backup_user'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT, LOCK TABLES, RELOAD ON tool_recommend.* TO 'backup_user'@'localhost';
```

---

## 十、常用SQL查询

### 10.1 业务查询

```sql
-- 1. 获取热门工具（综合排序）
SELECT
  t.*,
  (t.view_count * 0.3 + t.favorite_count * 2 + t.upvote_count * 1.5) AS hot_score
FROM tool t
WHERE t.status = 1
ORDER BY hot_score DESC
LIMIT 20;

-- 2. 获取用户收藏的工具列表
SELECT t.*
FROM tool t
INNER JOIN user_action ua ON t.id = ua.tool_id
WHERE ua.user_id = ?
  AND ua.action_type = 'FAVORITE'
ORDER BY ua.created_at DESC;

-- 3. 获取工具的评论统计
SELECT
  tool_id,
  COUNT(*) AS total_reviews,
  AVG(rating) AS avg_rating,
  SUM(CASE WHEN rating = 5 THEN 1 ELSE 0 END) AS five_star,
  SUM(CASE WHEN rating = 4 THEN 1 ELSE 0 END) AS four_star,
  SUM(CASE WHEN rating = 3 THEN 1 ELSE 0 END) AS three_star,
  SUM(CASE WHEN rating = 2 THEN 1 ELSE 0 END) AS two_star,
  SUM(CASE WHEN rating = 1 THEN 1 ELSE 0 END) AS one_star
FROM review
WHERE tool_id = ? AND status = 1
GROUP BY tool_id;

-- 4. 获取用户的浏览历史（去重）
SELECT DISTINCT t.*
FROM tool t
INNER JOIN user_action ua ON t.id = ua.tool_id
WHERE ua.user_id = ?
  AND ua.action_type = 'VIEW'
ORDER BY ua.created_at DESC
LIMIT 50;

-- 5. 获取相似工具（基于标签匹配）
SELECT
  t2.id,
  t2.name,
  COUNT(*) AS common_tags
FROM tool_tag tt1
INNER JOIN tool_tag tt2 ON tt1.tag_id = tt2.tag_id AND tt2.tool_id != tt1.tool_id
INNER JOIN tool t2 ON tt2.tool_id = t2.id
WHERE tt1.tool_id = ? AND t2.status = 1
GROUP BY t2.id, t2.name
ORDER BY common_tags DESC
LIMIT 6;
```

### 10.2 统计查询

```sql
-- 1. 每日新增用户数
SELECT
  DATE(created_at) AS date,
  COUNT(*) AS new_users
FROM user
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 2. 工具分类分布
SELECT
  c.name AS category_name,
  COUNT(t.id) AS tool_count
FROM category c
LEFT JOIN tool t ON c.id = t.category_id AND t.status = 1
WHERE c.parent_id IS NOT NULL
GROUP BY c.id, c.name
ORDER BY tool_count DESC;

-- 3. 用户活跃度统计
SELECT
  COUNT(DISTINCT CASE WHEN last_login_at >= CURDATE() THEN id END) AS dau,
  COUNT(DISTINCT CASE WHEN last_login_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY) THEN id END) AS wau,
  COUNT(DISTINCT CASE WHEN last_login_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) THEN id END) AS mau
FROM user;

-- 4. AI对话统计
SELECT
  DATE(created_at) AS date,
  COUNT(DISTINCT session_id) AS total_conversations,
  COUNT(*) AS total_messages,
  AVG(tokens_used) AS avg_tokens
FROM conversation
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

---

## 十一、表关系总结

```
核心实体关系：
- User 1:N UserAction (一个用户多次行为)
- User 1:N Review (一个用户多条评论)
- User 1:N Conversation (一个用户多个对话)
- Tool 1:N UserAction (一个工具被多次操作)
- Tool 1:N Review (一个工具有多条评论)
- Tool N:N Tag (多对多，通过tool_tag)
- Tool N:1 Category (多个工具属于一个分类)
- Tool N:N Tool (替代关系，通过tool_alternative)
- Review 1:N ReviewReply (一条评论多个回复)
- User 1:N Ticket (一个用户多个工单)
```

---

**文档版本**：v1.0
**最后更新**：2025-12-04
**审核状态**：待评审
