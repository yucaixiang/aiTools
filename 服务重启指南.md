# 服务重启指南

## 前提条件

在重启服务之前，请确保：
1. ✅ 数据库迁移已执行（favorite、tool_submission、help_request表已创建）
2. ✅ 所有代码修改已完成
3. ✅ API路径已统一（所有Controller使用/api前缀）

## 当前运行的服务

通过以下命令查看正在运行的服务：
```bash
lsof -i :8081 -i :8082 -i :8084 -i :8090 | grep LISTEN
```

## 重启步骤

### 1. 停止所有后端服务

```bash
# 找到所有Java进程
ps aux | grep -E "(gateway-service|user-service|review-service|tool-service)" | grep java | grep -v grep

# 停止所有服务（找到PID后替换<PID>）
# 或者使用以下命令一次性停止所有Java进程（谨慎使用！）
pkill -f "spring-boot"
```

### 2. 启动服务（推荐顺序）

建议按以下顺序启动服务，确保依赖关系：

#### 2.1 启动 Tool Service (端口 8081)
```bash
cd /Users/bjsttlp324/Desktop/tools/backend/tool-service
mvn clean spring-boot:run &
```

等待5-10秒，检查启动日志：
```bash
tail -f logs/tool-service.log  # 如果有日志文件
```

#### 2.2 启动 User Service (端口 8082) - **重要：包含新的收藏功能**
```bash
cd /Users/bjsttlp324/Desktop/tools/backend/user-service
mvn clean spring-boot:run &
```

#### 2.3 启动 Review Service (端口 8084) - **重要：包含评论功能修复**
```bash
cd /Users/bjsttlp324/Desktop/tools/backend/review-service
mvn clean spring-boot:run &
```

#### 2.4 启动 Gateway Service (端口 8090) - **重要：包含路由更新**
```bash
cd /Users/bjsttlp324/Desktop/tools/backend/gateway-service
mvn clean spring-boot:run &
```

### 3. 验证服务启动

等待所有服务启动完成（约30-60秒），然后验证：

```bash
# 检查端口占用
lsof -i :8081 -i :8082 -i :8084 -i :8090 | grep LISTEN

# 检查服务健康状态
curl http://localhost:8082/actuator/health  # User Service
curl http://localhost:8084/actuator/health  # Review Service
curl http://localhost:8090/actuator/health  # Gateway Service
```

预期所有请求返回：
```json
{"status":"UP",...}
```

## 快速重启脚本

创建一个脚本 `restart_services.sh`：

```bash
#!/bin/bash

echo "正在停止所有服务..."
pkill -f "tool-service"
pkill -f "user-service"
pkill -f "review-service"
pkill -f "gateway-service"

sleep 3

echo "正在启动 Tool Service..."
cd /Users/bjsttlp324/Desktop/tools/backend/tool-service
nohup mvn spring-boot:run > /tmp/tool-service.log 2>&1 &
sleep 10

echo "正在启动 User Service..."
cd /Users/bjsttlp324/Desktop/tools/backend/user-service
nohup mvn spring-boot:run > /tmp/user-service.log 2>&1 &
sleep 10

echo "正在启动 Review Service..."
cd /Users/bjsttlp324/Desktop/tools/backend/review-service
nohup mvn spring-boot:run > /tmp/review-service.log 2>&1 &
sleep 10

echo "正在启动 Gateway Service..."
cd /Users/bjsttlp324/Desktop/tools/backend/gateway-service
nohup mvn spring-boot:run > /tmp/gateway-service.log 2>&1 &

echo "所有服务启动中，请等待30秒后验证..."
sleep 30

echo "验证服务状态..."
curl -s http://localhost:8082/actuator/health | grep -q "UP" && echo "✅ User Service: UP" || echo "❌ User Service: DOWN"
curl -s http://localhost:8084/actuator/health | grep -q "UP" && echo "✅ Review Service: UP" || echo "❌ Review Service: DOWN"
curl -s http://localhost:8090/actuator/health | grep -q "UP" && echo "✅ Gateway Service: UP" || echo "❌ Gateway Service: DOWN"

echo ""
echo "日志文件位置:"
echo "  - User Service: /tmp/user-service.log"
echo "  - Review Service: /tmp/review-service.log"
echo "  - Gateway Service: /tmp/gateway-service.log"
```

使用方法：
```bash
chmod +x restart_services.sh
./restart_services.sh
```

## 问题排查

### 服务无法启动

1. 检查端口是否被占用：
```bash
lsof -i :8082  # 或其他端口
```

2. 查看错误日志：
```bash
tail -f /tmp/user-service.log
tail -f /tmp/review-service.log
tail -f /tmp/gateway-service.log
```

### 数据库连接失败

检查MySQL是否运行：
```bash
mysql -uroot -p123456 -e "SELECT 1"
```

### Redis连接失败

检查Redis是否运行：
```bash
redis-cli ping
```

应该返回 `PONG`

## 本次更新涉及的关键修改

### FavoriteController.java
- 路径：`/backend/user-service/src/main/java/com/toolrecommend/user/controller/FavoriteController.java`
- **修改**：`@RequestMapping` 从 `/favorites` 改为 `/api/favorites`

### ReviewController.java
- 路径：`/backend/review-service/src/main/java/com/toolrecommend/review/controller/ReviewController.java`
- **修改**：`@RequestMapping` 从 `/reviews` 改为 `/api/reviews`

### gateway-service/application.yml
- **修改**：确保所有路由使用 `StripPrefix=0`（因为Controller已包含完整路径）
- **新增**：`/api/favorites/**` 路由到 user-service

## 重启后需要测试的功能

### 1. 收藏功能测试
```bash
# 检查收藏状态
curl -X GET "http://localhost:8090/api/favorites/1/check" \
  -H "X-User-Id: 1"

# 添加收藏
curl -X POST "http://localhost:8090/api/favorites/1" \
  -H "X-User-Id: 1" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 获取我的收藏
curl -X GET "http://localhost:8090/api/favorites/my?current=1&size=20" \
  -H "X-User-Id: 1"
```

### 2. 评论功能测试
```bash
# 获取工具评论列表
curl -X GET "http://localhost:8090/api/reviews/tool/1?current=1&size=10"

# 创建评论（不需要标题）
curl -X POST "http://localhost:8090/api/reviews" \
  -H "Content-Type: application/json" \
  -H "X-User-Id: 1" \
  -d '{
    "toolId": 1,
    "rating": 5,
    "content": "很好用的工具！"
  }'

# 获取我的评论
curl -X GET "http://localhost:8090/api/reviews/my?current=1&size=20" \
  -H "X-User-Id: 1"
```

## 完成标志

✅ 所有服务正常启动
✅ 健康检查返回 UP
✅ 收藏API返回200
✅ 评论API返回200
✅ 前端可以正常访问

---

**更新时间**: 2025-12-10
**版本**: v1.1
