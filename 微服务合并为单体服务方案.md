# 微服务合并为单体服务方案

**日期**: 2025-12-10
**目标**: 将5个微服务合并为1个单体应用,降低复杂度和部署难度

---

## 1. 现状分析

### 当前微服务架构

```
┌─────────────────┐
│   Gateway       │  8090端口 (保留,作为反向代理)
└────────┬────────┘
         │
    ┌────┴────┬────────┬──────────┬──────────┐
    │         │        │          │          │
┌───▼───┐ ┌──▼───┐ ┌──▼───┐  ┌───▼───┐  ┌──▼──────┐
│User   │ │Tool  │ │Review│  │AI     │  │Admin    │
│8082   │ │8081  │ │8084  │  │8083   │  │8085     │
└───────┘ └──────┘ └──────┘  └───────┘  └─────────┘
```

### 问题
1. 服务间调用复杂(RestTemplate)
2. 部署繁琐(需要启动5个服务)
3. 端口管理复杂
4. 数据一致性难以保证
5. 事务管理困难

---

## 2. 目标架构

### 单体应用架构

```
┌─────────────────┐
│   Gateway       │  8090端口 (可选,或直接访问)
└────────┬────────┘
         │
    ┌────▼────────────────┐
    │  Monolith Service   │  8080端口
    │  ┌──────────────┐   │
    │  │User Module   │   │
    │  │Tool Module   │   │
    │  │Review Module │   │
    │  │AI Module     │   │
    │  │Admin Module  │   │
    │  └──────────────┘   │
    └─────────────────────┘
```

### 优点
1. ✅ 简化部署 - 只需启动1个应用
2. ✅ 简化开发 - 不需要服务间调用
3. ✅ 统一事务 - 使用@Transactional即可
4. ✅ 降低延迟 - 方法直接调用
5. ✅ 易于调试 - 所有代码在一个进程

---

## 3. 合并策略

### 3.1 项目结构

```
tool-recommend-monolith/
├── pom.xml
└── src/main/
    ├── java/com/toolrecommend/
    │   ├── ToolRecommendApplication.java  (主启动类)
    │   │
    │   ├── common/                    (公共模块)
    │   │   ├── entity/                (实体类)
    │   │   ├── vo/                    (VO类)
    │   │   ├── dto/                   (DTO类)
    │   │   ├── result/                (统一响应)
    │   │   ├── exception/             (异常类)
    │   │   └── util/                  (工具类)
    │   │
    │   ├── user/                      (用户模块)
    │   │   ├── controller/
    │   │   ├── service/
    │   │   ├── mapper/
    │   │   └── exception/
    │   │
    │   ├── tool/                      (工具模块)
    │   │   ├── controller/
    │   │   ├── service/
    │   │   ├── mapper/
    │   │   └── exception/
    │   │
    │   ├── review/                    (评论模块)
    │   │   ├── controller/
    │   │   ├── service/
    │   │   ├── mapper/
    │   │   └── exception/
    │   │
    │   ├── ai/                        (AI模块)
    │   │   ├── controller/
    │   │   ├── service/
    │   │   └── exception/
    │   │
    │   ├── admin/                     (管理模块)
    │   │   ├── controller/
    │   │   ├── service/
    │   │   └── exception/
    │   │
    │   └── config/                    (配置类)
    │       ├── MybatisPlusConfig.java
    │       ├── RedisConfig.java
    │       ├── CorsConfig.java
    │       ├── GlobalExceptionHandler.java
    │       └── WebMvcConfig.java
    │
    └── resources/
        ├── application.yml            (统一配置)
        ├── application-dev.yml
        ├── application-prod.yml
        └── mapper/                    (所有Mapper XML)
            ├── user/
            ├── tool/
            ├── review/
            └── admin/
```

---

## 4. 详细合并步骤

### 步骤1: 创建单体项目基础结构

```bash
cd /Users/bjsttlp324/Desktop/tools/backend
mkdir -p tool-recommend-monolith/src/main/java/com/toolrecommend
mkdir -p tool-recommend-monolith/src/main/resources/mapper
```

### 步骤2: 合并pom.xml依赖

**新项目依赖** (`tool-recommend-monolith/pom.xml`):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version>
    </parent>

    <groupId>com.toolrecommend</groupId>
    <artifactId>tool-recommend-monolith</artifactId>
    <version>1.0.0</version>
    <name>Tool Recommend Monolith</name>

    <properties>
        <java.version>17</java.version>
        <mybatis-plus.version>3.5.7</mybatis-plus.version>
        <jwt.version>0.12.3</jwt.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- MyBatis Plus -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>${mybatis-plus.version}</version>
        </dependency>

        <!-- MySQL -->
        <dependency>
            <groupId>com.mysql</groupId>
            <artifactId>mysql-connector-j</artifactId>
            <scope>runtime</scope>
        </dependency>

        <!-- Redis -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <!-- JWT -->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-api</artifactId>
            <version>${jwt.version}</version>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-impl</artifactId>
            <version>${jwt.version}</version>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-jackson</artifactId>
            <version>${jwt.version}</version>
            <scope>runtime</scope>
        </dependency>

        <!-- Validation -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <!-- Security (密码加密) -->
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-crypto</artifactId>
        </dependency>

        <!-- Hutool工具包 -->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.8.24</version>
        </dependency>

        <!-- FastJSON -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson2</artifactId>
            <version>2.0.45</version>
        </dependency>

        <!-- Commons Lang3 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- Actuator -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

### 步骤3: 复制公共模块

```bash
# 复制common模块的所有内容
cp -r common/src/main/java/com/toolrecommend/common/* \
      tool-recommend-monolith/src/main/java/com/toolrecommend/common/
```

### 步骤4: 按模块复制各服务代码

#### 用户模块
```bash
# Controller
cp user-service/src/main/java/com/toolrecommend/user/controller/* \
   tool-recommend-monolith/src/main/java/com/toolrecommend/user/controller/

# Service
cp user-service/src/main/java/com/toolrecommend/user/service/* \
   tool-recommend-monolith/src/main/java/com/toolrecommend/user/service/

# Mapper
cp user-service/src/main/java/com/toolrecommend/user/mapper/* \
   tool-recommend-monolith/src/main/java/com/toolrecommend/user/mapper/

# Exception
cp user-service/src/main/java/com/toolrecommend/user/exception/* \
   tool-recommend-monolith/src/main/java/com/toolrecommend/user/exception/

# Mapper XML (如果有)
cp user-service/src/main/resources/mapper/* \
   tool-recommend-monolith/src/main/resources/mapper/user/
```

#### 工具模块
```bash
# 同样复制 tool-service 的代码到 tool-recommend-monolith/src/main/java/com/toolrecommend/tool/
```

#### 评论模块
```bash
# 同样复制 review-service 的代码到 tool-recommend-monolith/src/main/java/com/toolrecommend/review/
```

#### AI模块
```bash
# 同样复制 ai-service 的代码到 tool-recommend-monolith/src/main/java/com/toolrecommend/ai/
```

#### 管理模块
```bash
# 同样复制 admin-service 的代码到 tool-recommend-monolith/src/main/java/com/toolrecommend/admin/
```

### 步骤5: 合并配置文件

**application.yml**:

```yaml
server:
  port: 8080

spring:
  application:
    name: tool-recommend-monolith

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/tool_recommend?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false
    username: root
    password: root123456
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      connection-timeout: 30000

  redis:
    host: localhost
    port: 6379
    password: redis123456
    database: 0

# MyBatis Plus配置
mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: com.toolrecommend.common.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-value: 1
      logic-not-delete-value: 0

# JWT配置
jwt:
  secret: tool-recommend-secret-key-2024-should-be-very-long-and-secure
  expiration: 604800000

# 日志配置
logging:
  level:
    com.toolrecommend: DEBUG
```

### 步骤6: 修改代码

#### 删除服务间调用
由于现在是单体应用,之前的RestTemplate调用都要改成直接注入Service

**修改前** (FavoriteServiceImpl.java):
```java
@Service
public class FavoriteServiceImpl {
    private final RestTemplate restTemplate;

    public PageResult<ToolVO> getUserFavorites(Long userId) {
        // RestTemplate调用tool-service
        ToolVO tool = restTemplate.getForObject(url, ToolVO.class);
    }
}
```

**修改后**:
```java
@Service
public class FavoriteServiceImpl {
    private final ToolService toolService;  // 直接注入

    public PageResult<ToolVO> getUserFavorites(Long userId) {
        // 直接方法调用
        ToolVO tool = toolService.getToolById(toolId);
    }
}
```

#### 合并GlobalExceptionHandler
将各服务的GlobalExceptionHandler合并为一个:

```java
package com.toolrecommend.config;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {
    // 合并所有异常处理方法
}
```

#### 修改Controller路径
保持API路径不变,确保前端无需修改:

```java
@RestController
@RequestMapping("/api/users")  // 保持原路径
public class UserController {
    // ...
}

@RestController
@RequestMapping("/api/tools")  // 保持原路径
public class ToolController {
    // ...
}
```

---

## 5. Gateway配置调整

由于所有服务合并为一个,Gateway配置需要简化:

**gateway-service/src/main/resources/application.yml**:

```yaml
spring:
  cloud:
    gateway:
      routes:
        # 所有API请求都转发到单体服务
        - id: monolith-service
          uri: http://localhost:8080
          predicates:
            - Path=/api/**
          filters:
            - StripPrefix=0
```

**或者完全移除Gateway**,直接访问单体服务:
- 前端配置: `baseURL: 'http://localhost:8080/api'`

---

## 6. 需要处理的特殊情况

### 6.1 事务管理
单体应用中可以使用`@Transactional`实现跨模块事务:

```java
@Transactional
public void createToolWithReview(ToolDTO toolDTO, ReviewDTO reviewDTO) {
    // 创建工具
    toolService.createTool(toolDTO);
    // 创建评论
    reviewService.createReview(reviewDTO);
    // 如果任何一步失败,全部回滚
}
```

### 6.2 循环依赖
如果有循环依赖,使用`@Lazy`注解:

```java
@Service
public class UserService {
    private final FavoriteService favoriteService;

    public UserService(@Lazy FavoriteService favoriteService) {
        this.favoriteService = favoriteService;
    }
}
```

### 6.3 配置类冲突
如果有相同的配置类,需要合并或重命名

---

## 7. 部署简化

### 开发环境
```bash
# 只需启动一个服务
cd tool-recommend-monolith
mvn spring-boot:run
```

### 生产环境
```bash
# 打包
mvn clean package -DskipTests

# 运行
java -jar target/tool-recommend-monolith-1.0.0.jar

# 或使用Docker
docker build -t tool-recommend .
docker run -p 8080:8080 tool-recommend
```

---

## 8. 测试计划

### 功能测试清单
- [ ] 用户注册/登录
- [ ] 工具CRUD
- [ ] 评论CRUD
- [ ] 收藏功能
- [ ] AI推荐
- [ ] 管理后台

### 性能测试
- 对比微服务架构的响应时间
- 内存占用
- 启动速度

---

## 9. 回滚方案

如果合并后出现问题:
1. 保留原微服务代码(不删除)
2. 可以快速切回微服务架构
3. 使用Git分支管理

---

## 10. 时间规划

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 1 | 创建项目结构 | 30分钟 |
| 2 | 复制代码 | 1小时 |
| 3 | 修改服务间调用 | 2小时 |
| 4 | 合并配置 | 30分钟 |
| 5 | 测试 | 2小时 |
| **总计** | | **6小时** |

---

## 11. 注意事项

1. ⚠️ **备份数据**: 合并前备份数据库
2. ⚠️ **保留原代码**: 不要删除原微服务代码
3. ⚠️ **渐进式迁移**: 可以先合并部分服务测试
4. ⚠️ **API兼容**: 保持API路径不变
5. ⚠️ **配置检查**: 仔细检查所有配置项

---

**下一步**: 是否开始执行合并?我可以帮你自动化完成大部分工作。

**版本**: v1.0
**作者**: AI Tool Recommend Team
**日期**: 2025-12-10
