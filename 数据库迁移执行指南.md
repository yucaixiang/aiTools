# 数据库迁移执行指南

## 概述

本次迁移将评分和评论功能分离，支持多级评论回复。

##

 迁移内容

1. **创建rating表** - 独立的评分表，一个用户对一个工具只能打一次分
2. **修改review表** - 添加parent_id支持回复功能，移除rating字段
3. **数据迁移** - 将现有的rating数据迁移到新的rating表
4. **创建触发器** - 自动更新统计数据

## 执行步骤

### 方法1: 使用MySQL命令行

```bash
# 1. 连接到MySQL
mysql -uroot -p

# 2. 执行迁移脚本
source /Users/bjsttlp324/Desktop/tools/scripts/migrate-rating-review.sql

# 3. 验证结果
USE tool_recommend;
SHOW TABLES;
DESC rating;
DESC review;
```

### 方法2: 使用MySQL Workbench

1. 打开MySQL Workbench
2. 连接到本地数据库
3. 打开文件: `/Users/bjsttlp324/Desktop/tools/scripts/migrate-rating-review.sql`
4. 点击执行（Lightning图标）
5. 查看执行结果

### 方法3: 使用DataGrip或其他IDE

1. 打开数据库连接
2. 打开SQL文件
3. 执行整个脚本
4. 查看执行日志

## 验证迁移成功

执行以下SQL验证：

```sql
-- 1. 检查rating表是否创建成功
SELECT COUNT(*) as rating_count FROM rating;

-- 2. 检查review表结构是否正确
DESC review;

-- 3. 检查是否有parent_id字段
SHOW COLUMNS FROM review LIKE 'parent_id';

-- 4. 检查触发器是否创建
SHOW TRIGGERS;

-- 5. 验证数据迁移
SELECT
  (SELECT COUNT(*) FROM review) as review_count,
  (SELECT COUNT(*) FROM rating) as rating_count;
```

## 注意事项

1. **备份数据库** - 迁移前请先备份：
   ```bash
   mysqldump -uroot -p tool_recommend > backup_$(date +%Y%m%d).sql
   ```

2. **停止应用** - 迁移期间建议停止后端服务

3. **检查触发器** - 触发器可能影响性能，生产环境建议在应用层更新统计

4. **回滚方案** - 迁移脚本末尾有完整的回滚SQL

## 迁移后的表结构

### rating表（新）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| tool_id | BIGINT | 工具ID |
| user_id | BIGINT | 用户ID |
| score | TINYINT | 评分1-5 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

- 唯一索引: (tool_id, user_id) - 保证一个用户对一个工具只能打一次分

### review表（修改后）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| tool_id | BIGINT | 工具ID |
| user_id | BIGINT | 用户ID |
| parent_id | BIGINT | 父评论ID（新增）|
| ~~rating~~ | - | 已移除 |
| title | VARCHAR(200) | 标题 |
| content | TEXT | 内容 |
| pros | JSON | 优点 |
| cons | JSON | 缺点 |
| usage_duration | ENUM | 使用时长 |
| helpful_count | INT | 有帮助数 |
| reply_count | INT | 回复数（新增）|
| status | TINYINT | 状态 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

- 移除了唯一索引: (tool_id, user_id) - 支持多条评论
- 新增索引: (tool_id, parent_id, created_at DESC)

## 回滚方案

如果迁移出现问题，执行脚本末尾的回滚SQL（已注释）：

```sql
-- 删除触发器
DROP TRIGGER IF EXISTS `after_rating_insert`;
-- ... 其他触发器

-- 恢复review表结构
ALTER TABLE `review`
ADD COLUMN `rating` TINYINT ...
-- ... 其他恢复操作

-- 删除rating表
DROP TABLE IF EXISTS `rating`;
```

## 执行清单

- [ ] 备份数据库
- [ ] 停止后端服务
- [ ] 执行迁移脚本
- [ ] 验证表结构
- [ ] 验证数据完整性
- [ ] 验证触发器
- [ ] 更新后端代码
- [ ] 重启后端服务
- [ ] 测试功能

## 下一步

迁移成功后，需要：

1. 更新后端Entity类
2. 创建Rating相关的Mapper、Service、Controller
3. 修改Review相关的代码支持回复
4. 更新前端界面
