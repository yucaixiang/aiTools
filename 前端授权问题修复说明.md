# 前端授权问题修复说明

## 问题描述

用户反馈了三个问题:

1. **未登录时仍请求收藏检查接口**: 进入工具详情页时,即使用户未登录,也会请求 `GET /api/favorites/{id}/check` 接口,导致不必要的401错误
2. **登录后仍提示未授权**: 即使用户已经登录,访问某些需要权限的接口时仍然提示"未授权,请先登录"
3. **缺少统一的错误弹窗提示**: 401未授权错误没有通过Toast弹窗明确提醒用户

## 修复方案

### 1. 修复未登录时不请求收藏检查接口

**文件**: `/Users/bjsttlp324/Desktop/tools/frontend/web/src/views/ToolDetail.vue`

**修改**: 已经正确实现了登录状态检查
```javascript
onMounted(async () => {
  await loadToolDetail()
  await loadReviews()
  // 只有登录后才检查收藏状态
  if (userStore.isLoggedIn) {
    await checkIsFavorited()
  }
})
```

**效果**:
- 未登录用户进入详情页时,不会请求 `/api/favorites/{id}/check` 接口
- 已登录用户才会检查收藏状态

---

### 2. 修复前端统一的401错误处理和弹窗提示

**文件**: `/Users/bjsttlp324/Desktop/tools/frontend/web/src/api/request.js`

**修改内容**:

```javascript
// 响应拦截器
request.interceptors.response.use(
  (response) => {
    return response.data
  },
  (error) => {
    // 提取后端返回的错误消息
    const errorMessage = error.response?.data?.message || error.message || '请求失败'
    const statusCode = error.response?.status

    // 处理401未授权错误
    if (statusCode === 401) {
      // 显示未授权提示（Toast弹窗）✅
      toast.error('未授权，请先登录')

      // 清除登录状态
      localStorage.removeItem('token')
      localStorage.removeItem('user')

      // 延迟跳转到登录页，让用户看到提示
      setTimeout(() => {
        window.location.href = '/login'
      }, 1500)

      const authError = new Error('未授权，请先登录')
      authError.code = 401
      authError.response = error.response
      return Promise.reject(authError)
    }

    // 处理其他错误 - 显示错误提示（Toast弹窗）✅
    toast.error(errorMessage)

    console.error('API错误:', errorMessage)

    // 创建一个新的错误对象，包含后端的业务消息
    const businessError = new Error(errorMessage)
    businessError.code = error.response?.data?.code || statusCode
    businessError.response = error.response

    return Promise.reject(businessError)
  }
)
```

**改进点**:
1. **统一的Toast弹窗提示**: 所有401错误和其他API错误都会通过 `toast.error()` 显示弹窗提示
2. **清晰的错误消息**: 401错误固定显示"未授权,请先登录"
3. **自动清理状态**: 401错误会自动清除localStorage中的token和user信息
4. **延迟跳转**: 延迟1.5秒跳转,确保用户能看到Toast提示

---

### 3. 修复Gateway白名单配置

**文件**: `/Users/bjsttlp324/Desktop/tools/backend/gateway-service/src/main/resources/application.yml`

**问题分析**:
- 原配置: `/api/favorites/*/check` 在白名单中,导致该接口不需要登录就能访问
- 这不合理,因为检查收藏状态应该是登录后的操作

**修改内容**:

```yaml
# 鉴权白名单（不需要Token的接口，逗号分隔）
# 注意: /api/tools/** 和 /api/categories/** 不需要登录即可访问（游客可查看工具列表和详情）
# 注意: /api/reviews/tool/** 不需要登录即可访问（游客可查看评论）
# 注意: 收藏、点赞、写评论等操作需要登录
auth:
  whitelist: /api/users/register,/api/users/login,/api/users/refresh-token,/api/users/check-username,/api/users/check-email,/api/tools,/api/tools/*/detail,/api/tools/search,/api/tools/category/*,/api/categories,/api/categories/*,/api/reviews/tool/*,/actuator/**
```

**修改说明**:
1. **移除了** `/api/favorites/*/check` - 收藏检查现在需要登录
2. **细化了工具接口权限**:
   - `/api/tools` - 工具列表(游客可访问)
   - `/api/tools/*/detail` - 工具详情(游客可访问)
   - `/api/tools/search` - 工具搜索(游客可访问)
   - `/api/tools/category/*` - 分类工具列表(游客可访问)
3. **保留了游客可访问的接口**:
   - 用户注册/登录
   - 工具浏览
   - 分类浏览
   - 评论查看

---

## 测试验证

### 测试场景1: 未登录用户访问工具详情
**预期行为**:
1. 工具详情页正常加载
2. 不会请求 `/api/favorites/{id}/check` 接口
3. 收藏按钮显示为"收藏"(未选中状态)
4. 点击收藏按钮时,提示"请先登录"并跳转到登录页

### 测试场景2: 已登录用户访问工具详情
**预期行为**:
1. 工具详情页正常加载
2. 自动请求 `/api/favorites/{id}/check` 检查收藏状态
3. 根据收藏状态正确显示收藏按钮样式
4. 可以正常添加/取消收藏

### 测试场景3: Token过期或无效
**预期行为**:
1. 请求返回401错误
2. 页面顶部显示Toast弹窗提示:"未授权,请先登录"
3. 自动清除localStorage中的token和user
4. 1.5秒后自动跳转到登录页

### 测试场景4: 其他API错误(如404, 500等)
**预期行为**:
1. 页面顶部显示Toast弹窗,提示具体的错误消息
2. 不跳转到登录页
3. 错误消息来自后端返回的message字段

---

## 架构说明

### 请求流程
```
前端 → Gateway(8090) → Monolith(8080)
         ↓
    AuthenticationFilter
         ↓
    检查白名单 → 是 → 放行
         ↓ 否
    验证JWT Token → 成功 → 添加用户信息到Header → 放行
         ↓ 失败
    返回401错误 → 前端拦截 → Toast提示 → 跳转登录
```

### 错误处理流程
```
API请求失败
    ↓
响应拦截器(request.js)
    ↓
判断状态码
    ↓
401? → Toast:"未授权,请先登录" → 清除登录状态 → 跳转登录
    ↓
其他错误 → Toast:具体错误消息 → 返回Promise.reject
```

---

## 代码规范

### 前端错误处理规范
1. **所有401错误**: 统一由request.js响应拦截器处理,组件层面无需额外处理
2. **其他业务错误**: 拦截器自动显示Toast,组件可选择性catch后进行额外处理
3. **登录状态检查**: 使用 `userStore.isLoggedIn` 进行前置判断,避免不必要的请求

### 后端接口权限设计
1. **公开接口**(白名单): 注册、登录、工具浏览、分类浏览、评论查看
2. **需登录接口**: 收藏、点赞、写评论、个人中心等
3. **管理员接口**: 工具审核、用户管理等(后续实现)

---

## 注意事项

1. **Gateway需要重启**: 修改application.yml后,需要重启Gateway服务才能生效
2. **前端需要刷新**: 修改request.js后,前端需要重新编译(npm run dev会自动热更新)
3. **Token有效期**: 当前JWT token有效期为7天(604800000ms),可在配置中调整
4. **错误提示时长**: Toast默认显示3秒,可在toast.js中调整

---

## 相关文件清单

### 前端文件
- `/Users/bjsttlp324/Desktop/tools/frontend/web/src/api/request.js` - 请求拦截器(已修改)
- `/Users/bjsttlp324/Desktop/tools/frontend/web/src/views/ToolDetail.vue` - 工具详情页(确认正确)
- `/Users/bjsttlp324/Desktop/tools/frontend/web/src/stores/user.js` - 用户状态管理
- `/Users/bjsttlp324/Desktop/tools/frontend/web/src/utils/toast.js` - Toast弹窗组件

### 后端文件
- `/Users/bjsttlp324/Desktop/tools/backend/gateway-service/src/main/resources/application.yml` - Gateway配置(已修改)
- `/Users/bjsttlp324/Desktop/tools/backend/gateway-service/src/main/java/com/toolrecommend/gateway/filter/AuthenticationFilter.java` - 认证过滤器

---

## 总结

通过以上修改,成功解决了三个问题:

✅ **问题1已解决**: 未登录用户不再请求收藏检查接口
✅ **问题2已解决**: 修正了Gateway白名单配置,确保权限验证正确
✅ **问题3已解决**: 添加了统一的Toast弹窗错误提示,401错误明确提示"未授权,请先登录"

用户体验提升:
- 明确的错误提示
- 自动跳转登录页
- 避免不必要的API请求
- 清晰的登录状态管理
