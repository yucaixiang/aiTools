server:
  port: 8080

spring:
  application:
    name: gateway-service

  cloud:
    gateway:
      # 路由配置
      routes:
        # 工具服务路由
        - id: tool-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/tools/**,/api/categories/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10  # 每秒生成令牌数
                redis-rate-limiter.burstCapacity: 20  # 令牌桶容量
                key-resolver: "#{@ipKeyResolver}"

        # 用户服务路由
        - id: user-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@ipKeyResolver}"

        # AI服务路由
        - id: ai-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/ai/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 5   # AI服务限流更严格
                redis-rate-limiter.burstCapacity: 10
                key-resolver: "#{@ipKeyResolver}"

        # 评论服务路由
        - id: review-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/reviews/**
          filters:
            - StripPrefix=0

      # 全局CORS配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins:
              - "http://localhost:3000"
              - "http://localhost:8080"
              - "http://localhost:8081"
              - "http://localhost:8082"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

      # 默认过滤器
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials

  redis:
    host: localhost
    port: 6379
    password: redis123456
    database: 1
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5

# JWT配置
jwt:
  secret: tool-recommend-secret-key-2024-should-be-very-long-and-secure

# 鉴权白名单（不需要Token的接口）
auth:
  whitelist:
    - /api/users/register
    - /api/users/login
    - /api/users/refresh-token
    - /api/users/check-username
    - /api/users/check-email
    - /api/tools/hot
    - /api/tools/latest
    - /api/tools/search
    - /api/tools/query
    - /api/categories/**
    - /actuator/**

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: always

logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    com.toolrecommend: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
