# 评分评论功能改造实施计划

## 需求概述

1. **评论支持多条** - 用户可以对同一工具发表多条评论
2. **评论支持回复** - 支持完整的多级评论回复功能
3. **评分独立** - 评分功能从评论中拆分，一个用户对一个工具只能打一次分
4. **实时统计更新** - 工具的评分数、收藏数、评论数实时更新
5. **界面优化** - 工具详情页"推荐人数"改为"收藏人数"

## 架构设计

### 数据库设计

#### 新增rating表
```sql
CREATE TABLE `rating` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `tool_id` BIGINT NOT NULL,
  `user_id` BIGINT NOT NULL,
  `score` TINYINT NOT NULL COMMENT '评分1-5',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_tool_user` (`tool_id`, `user_id`)
);
```

#### 修改review表
```sql
-- 添加字段
ALTER TABLE `review`
ADD COLUMN `parent_id` BIGINT DEFAULT NULL COMMENT '父评论ID',
ADD COLUMN `reply_count` INT DEFAULT 0 COMMENT '回复数';

-- 移除字段
ALTER TABLE `review`
DROP COLUMN `rating`;

-- 移除唯一索引（支持多条评论）
ALTER TABLE `review`
DROP INDEX `uk_tool_user`;
```

### API设计

#### Rating API
- `POST /api/ratings` - 提交评分
- `PUT /api/ratings/{toolId}` - 更新评分
- `GET /api/ratings/{toolId}/my` - 获取我的评分
- `DELETE /api/ratings/{toolId}` - 删除评分

#### Review API (修改)
- `POST /api/reviews` - 创建评论/回复
  - body包含`parentId`字段，为null时是顶级评论，否则是回复
- `GET /api/reviews/tool/{toolId}` - 获取工具的评论列表（树形结构）
- `GET /api/reviews/{id}/replies` - 获取某评论的回复列表
- `POST /api/reviews/{id}/reply` - 回复某条评论（简化接口）

## 实施步骤

### 阶段1: 数据库迁移 ✅

**已完成**:
- ✅ 创建数据库迁移脚本: `/Users/bjsttlp324/Desktop/tools/scripts/migrate-rating-review.sql`
- ✅ 创建迁移执行指南: `/Users/bjsttlp324/Desktop/tools/数据库迁移执行指南.md`

**待执行**:
- ⏳ 手动执行数据库迁移脚本（参考执行指南）

### 阶段2: 后端实现

#### 2.1 Rating功能实现 (约2-3小时)

**需要创建的文件**:
1. Entity: `/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/entity/Rating.java`
2. Mapper: `/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/mapper/RatingMapper.java`
3. Mapper XML: `/tool-recommend-monolith/src/main/resources/mapper/RatingMapper.xml`
4. DTO:
   - `RatingCreateDTO.java`
   - `RatingUpdateDTO.java`
5. Service: `/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/service/RatingService.java`
6. ServiceImpl: `/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/service/impl/RatingServiceImpl.java`
7. Controller: `/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/controller/RatingController.java`

**核心功能**:
- 创建/更新评分（一个用户对一个工具只能有一条评分记录）
- 获取工具的平均评分和评分人数
- 获取用户对某工具的评分
- 删除评分

#### 2.2 Review功能改造 (约3-4小时)

**需要修改的文件**:
1. Entity: `Review.java` - 添加parentId和replyCount字段
2. DTO: 修改`ReviewCreateDTO`添加parentId
3. VO: 创建`ReviewTreeVO`支持树形结构
4. Service: 修改支持回复功能
5. Controller: 添加回复相关接口

**核心功能**:
- 发表评论（顶级评论parentId为null）
- 回复评论（设置parentId）
- 获取评论树形结构
- 获取某评论的回复列表
- 删除评论时级联删除回复

#### 2.3 统计更新功能 (约2小时)

**需要修改的文件**:
1. `ToolService.java` - 添加统计更新方法
2. `RatingService.java` - 评分后更新average_rating
3. `ReviewService.java` - 评论后更新review_count
4. `FavoriteService.java` - 收藏后更新favorite_count

**核心功能**:
- 评分时实时更新工具的average_rating
- 发表评论时更新review_count（只统计顶级评论）
- 回复评论时更新父评论的reply_count
- 收藏时更新favorite_count

### 阶段3: 前端实现

#### 3.1 评分组件 (约2小时)

**文件**:
- `/frontend/web/src/components/RatingStars.vue` - 评分星星组件
- `/frontend/web/src/api/rating.js` - 评分API

**功能**:
- 显示平均评分和评分人数
- 用户提交评分
- 修改已有评分
- 显示当前用户的评分状态

#### 3.2 评论回复组件 (约3-4小时)

**文件**:
- `/frontend/web/src/components/ReviewList.vue` - 评论列表（树形）
- `/frontend/web/src/components/ReviewItem.vue` - 单条评论项
- `/frontend/web/src/components/ReplyForm.vue` - 回复表单
- `/frontend/web/src/api/review.js` - 更新评论API

**功能**:
- 显示评论树形结构
- 展开/折叠回复
- 回复评论
- 删除评论/回复

#### 3.3 工具详情页优化 (约1小时)

**文件**:
- `/frontend/web/src/views/ToolDetail.vue`

**修改**:
- "推荐人数" → "收藏人数"
- 集成独立的评分组件
- 集成新的评论回复组件
- 实时更新统计数据

#### 3.4 工具列表优化 (约1小时)

**文件**:
- `/frontend/web/src/views/ToolList.vue`
- `/frontend/web/src/components/ToolCard.vue`

**修改**:
- 实时更新评分、收藏数、评论数
- 优化显示样式

## 预计工期

| 阶段 | 内容 | 预计工时 | 状态 |
|------|------|----------|------|
| 1 | 数据库设计和迁移 | 2h | ✅ 完成 |
| 2.1 | 后端Rating功能 | 3h | ⏳ 待开始 |
| 2.2 | 后端Review改造 | 4h | ⏳ 待开始 |
| 2.3 | 统计更新功能 | 2h | ⏳ 待开始 |
| 3.1 | 前端评分组件 | 2h | ⏳ 待开始 |
| 3.2 | 前端评论回复 | 4h | ⏳ 待开始 |
| 3.3 | 工具详情优化 | 1h | ⏳ 待开始 |
| 3.4 | 工具列表优化 | 1h | ⏳ 待开始 |
| **总计** | | **19h** | |

## 风险和注意事项

### 数据库迁移风险

1. **数据丢失** - 迁移前必须备份数据库
2. **触发器性能** - 触发器可能影响写入性能，生产环境建议禁用
3. **索引变更** - 移除唯一索引可能导致重复数据

**缓解措施**:
- 在测试环境先执行迁移
- 备份原始数据
- 准备回滚脚本

### 功能变更影响

1. **现有评论** - 已有的评论会迁移rating到rating表
2. **API兼容性** - 前端需要同步更新
3. **缓存失效** - Redis中的缓存需要清理

**缓解措施**:
- 前后端同步上线
- 清理Redis缓存
- 充分测试

## 测试计划

### 后端测试

- [ ] Rating CRUD测试
- [ ] 评分唯一性测试
- [ ] Review回复功能测试
- [ ] 级联删除测试
- [ ] 统计更新准确性测试
- [ ] 并发测试

### 前端测试

- [ ] 评分提交和显示
- [ ] 评论发表和回复
- [ ] 评论树形展示
- [ ] 统计数据实时更新
- [ ] 边界情况处理

### 集成测试

- [ ] 完整流程测试（评分+评论+收藏）
- [ ] 权限测试
- [ ] 性能测试

## 当前进度

✅ **已完成**:
1. 需求分析
2. 数据库设计
3. 迁移脚本编写
4. 迁移指南编写

⏳ **进行中**:
- 等待手动执行数据库迁移

📋 **下一步**:
1. 手动执行数据库迁移（参考：`/Users/bjsttlp324/Desktop/tools/数据库迁移执行指南.md`）
2. 实现后端Rating功能
3. 修改Review支持回复
4. 实现前端界面

## 参考文档

1. 数据库迁移脚本: `/Users/bjsttlp324/Desktop/tools/scripts/migrate-rating-review.sql`
2. 迁移执行指南: `/Users/bjsttlp324/Desktop/tools/数据库迁移执行指南.md`
3. 现有代码目录:
   - 后端: `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith`
   - 前端: `/Users/bjsttlp324/Desktop/tools/frontend/web`

## 交付物

### 代码交付

- [ ] Rating完整功能代码
- [ ] Review回复功能代码
- [ ] 统计更新逻辑代码
- [ ] 前端评分组件
- [ ] 前端评论回复组件
- [ ] 优化后的工具详情页
- [ ] 优化后的工具列表页

### 文档交付

- [x] 数据库迁移脚本
- [x] 迁移执行指南
- [x] 实施计划（本文档）
- [ ] API文档更新
- [ ] 测试报告

---

**说明**: 本文档会随着开发进度持续更新。
