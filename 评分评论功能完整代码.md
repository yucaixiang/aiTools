# 评分评论功能完整代码

## 使用说明

本文档包含所有需要创建和修改的代码。请按照文件路径创建相应的文件。

**重要提示**：
1. 先执行数据库迁移脚本
2. 按顺序创建/修改文件
3. 重新编译并重启后端服务
4. 前端代码会自动热重载

---

## 后端代码

### 1. Rating DTO类

#### RatingDTO.java
路径: `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith/src/main/java/com/toolrecommend/common/dto/RatingDTO.java`

```java
package com.toolrecommend.common.dto;

import lombok.Data;
import jakarta.validation.constraints.Max;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotNull;

/**
 * 评分DTO
 */
@Data
public class RatingDTO {

    /**
     * 工具ID
     */
    @NotNull(message = "工具ID不能为空")
    private Long toolId;

    /**
     * 评分(1-5)
     */
    @NotNull(message = "评分不能为空")
    @Min(value = 1, message = "评分最小为1")
    @Max(value = 5, message = "评分最大为5")
    private Integer score;
}
```

### 2. Rating VO类

#### RatingStatsVO.java
路径: `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith/src/main/java/com/toolrecommend/common/vo/RatingStatsVO.java`

```java
package com.toolrecommend.common.vo;

import lombok.Data;
import java.math.BigDecimal;

/**
 * 评分统计VO
 */
@Data
public class RatingStatsVO {

    /**
     * 平均评分
     */
    private BigDecimal averageRating;

    /**
     * 评分人数
     */
    private Integer ratingCount;

    /**
     * 当前用户的评分（如果已登录且已评分）
     */
    private Integer userScore;
}
```

### 3. Rating Service

#### RatingService.java
路径: `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/service/RatingService.java`

```java
package com.toolrecommend.rating.service;

import com.toolrecommend.common.dto.RatingDTO;
import com.toolrecommend.common.vo.RatingStatsVO;

/**
 * 评分服务接口
 */
public interface RatingService {

    /**
     * 提交或更新评分
     */
    void submitRating(Long userId, RatingDTO ratingDTO);

    /**
     * 获取工具的评分统计
     */
    RatingStatsVO getToolRatingStats(Long toolId, Long userId);

    /**
     * 删除评分
     */
    void deleteRating(Long userId, Long toolId);

    /**
     * 检查用户是否已评分
     */
    boolean hasRated(Long userId, Long toolId);
}
```

#### RatingServiceImpl.java
路径: `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/service/impl/RatingServiceImpl.java`

```java
package com.toolrecommend.rating.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.toolrecommend.common.dto.RatingDTO;
import com.toolrecommend.common.vo.RatingStatsVO;
import com.toolrecommend.rating.entity.Rating;
import com.toolrecommend.rating.mapper.RatingMapper;
import com.toolrecommend.rating.service.RatingService;
import com.toolrecommend.tool.service.ToolService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Map;

/**
 * 评分服务实现
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class RatingServiceImpl implements RatingService {

    private final RatingMapper ratingMapper;
    private final ToolService toolService;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void submitRating(Long userId, RatingDTO ratingDTO) {
        // 查询是否已有评分
        Rating existing = ratingMapper.getUserRating(ratingDTO.getToolId(), userId);

        if (existing != null) {
            // 更新评分
            existing.setScore(ratingDTO.getScore());
            ratingMapper.updateById(existing);
            log.info("用户{}更新工具{}的评分为{}", userId, ratingDTO.getToolId(), ratingDTO.getScore());
        } else {
            // 创建新评分
            Rating rating = new Rating();
            rating.setToolId(ratingDTO.getToolId());
            rating.setUserId(userId);
            rating.setScore(ratingDTO.getScore());
            ratingMapper.insert(rating);
            log.info("用户{}对工具{}评分{}", userId, ratingDTO.getToolId(), ratingDTO.getScore());
        }

        // 更新工具的平均评分
        updateToolAverageRating(ratingDTO.getToolId());
    }

    @Override
    public RatingStatsVO getToolRatingStats(Long toolId, Long userId) {
        Map<String, Object> stats = ratingMapper.getToolRatingStats(toolId);

        RatingStatsVO vo = new RatingStatsVO();
        vo.setAverageRating((BigDecimal) stats.get("averageRating"));
        vo.setRatingCount(((Long) stats.get("ratingCount")).intValue());

        // 如果用户已登录，获取用户的评分
        if (userId != null) {
            Rating userRating = ratingMapper.getUserRating(toolId, userId);
            if (userRating != null) {
                vo.setUserScore(userRating.getScore());
            }
        }

        return vo;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public void deleteRating(Long userId, Long toolId) {
        LambdaQueryWrapper<Rating> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(Rating::getToolId, toolId)
               .eq(Rating::getUserId, userId);

        int deleted = ratingMapper.delete(wrapper);
        if (deleted > 0) {
            log.info("用户{}删除对工具{}的评分", userId, toolId);
            // 更新工具的平均评分
            updateToolAverageRating(toolId);
        }
    }

    @Override
    public boolean hasRated(Long userId, Long toolId) {
        return ratingMapper.getUserRating(toolId, userId) != null;
    }

    /**
     * 更新工具的平均评分
     */
    private void updateToolAverageRating(Long toolId) {
        BigDecimal avgRating = ratingMapper.getAverageRating(toolId);
        toolService.updateAverageRating(toolId, avgRating);
    }
}
```

### 4. Rating Controller

#### RatingController.java
路径: `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith/src/main/java/com/toolrecommend/rating/controller/RatingController.java`

```java
package com.toolrecommend.rating.controller;

import com.toolrecommend.common.dto.RatingDTO;
import com.toolrecommend.common.result.Result;
import com.toolrecommend.common.vo.RatingStatsVO;
import com.toolrecommend.rating.service.RatingService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

/**
 * 评分控制器
 */
@RestController
@RequestMapping("/api/ratings")
@RequiredArgsConstructor
public class RatingController {

    private final RatingService ratingService;

    /**
     * 提交或更新评分
     */
    @PostMapping
    public Result<Void> submitRating(
            @Valid @RequestBody RatingDTO ratingDTO,
            @RequestHeader("X-User-Id") Long userId) {
        ratingService.submitRating(userId, ratingDTO);
        return Result.success();
    }

    /**
     * 获取工具的评分统计
     */
    @GetMapping("/tool/{toolId}")
    public Result<RatingStatsVO> getToolRatingStats(
            @PathVariable Long toolId,
            @RequestHeader(value = "X-User-Id", required = false) Long userId) {
        RatingStatsVO stats = ratingService.getToolRatingStats(toolId, userId);
        return Result.success(stats);
    }

    /**
     * 删除评分
     */
    @DeleteMapping("/tool/{toolId}")
    public Result<Void> deleteRating(
            @PathVariable Long toolId,
            @RequestHeader("X-User-Id") Long userId) {
        ratingService.deleteRating(userId, toolId);
        return Result.success();
    }

    /**
     * 检查是否已评分
     */
    @GetMapping("/tool/{toolId}/check")
    public Result<Boolean> checkRating(
            @PathVariable Long toolId,
            @RequestHeader("X-User-Id") Long userId) {
        boolean hasRated = ratingService.hasRated(userId, toolId);
        return Result.success(hasRated);
    }
}
```

### 5. 修改ToolService添加更新评分方法

在 `ToolService.java` 中添加方法：

```java
/**
 * 更新工具的平均评分
 */
void updateAverageRating(Long toolId, BigDecimal averageRating);
```

在 `ToolServiceImpl.java` 中实现：

```java
@Override
@Transactional(rollbackFor = Exception.class)
public void updateAverageRating(Long toolId, BigDecimal averageRating) {
    Tool tool = new Tool();
    tool.setId(toolId);
    tool.setAverageRating(averageRating);
    toolMapper.updateById(tool);

    // 清除缓存
    String cacheKey = "tool:detail:" + toolId;
    redisTemplate.delete(cacheKey);
}
```

### 6. 修改Review实体支持回复

修改 `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith/src/main/java/com/toolrecommend/common/entity/Review.java`:

找到Review类，添加以下字段：

```java
/**
 * 父评论ID（NULL表示顶级评论）
 */
private Long parentId;

/**
 * 回复数
 */
private Integer replyCount;
```

**同时删除rating字段**（如果存在）。

### 7. 修改ReviewDTO支持回复

修改 `ReviewCreateDTO.java`，添加：

```java
/**
 * 父评论ID（回复时需要）
 */
private Long parentId;
```

**同时删除rating字段的校验**。

### 8. 创建ReviewTreeVO用于树形结构

创建文件: `/Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith/src/main/java/com/toolrecommend/common/vo/ReviewTreeVO.java`

```java
package com.toolrecommend.common.vo;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

/**
 * 评论树形结构VO
 */
@Data
public class ReviewTreeVO {

    private Long id;
    private Long toolId;
    private Long userId;
    private String username;
    private String userAvatar;
    private Long parentId;
    private String content;
    private Integer helpfulCount;
    private Integer replyCount;
    private LocalDateTime createdAt;

    /**
     * 子回复列表
     */
    private List<ReviewTreeVO> replies;

    /**
     * 当前用户是否点了有帮助
     */
    private Boolean isHelpful;

    /**
     * 是否是当前用户的评论
     */
    private Boolean isMine;
}
```

### 9. 修改ReviewService支持回复

修改 `ReviewService.java`，添加方法：

```java
/**
 * 获取工具的评论树形结构
 */
List<ReviewTreeVO> getToolReviewsTree(Long toolId, Long userId);

/**
 * 获取某条评论的回复列表
 */
PageResult<ReviewVO> getReviewReplies(Long reviewId, Long current, Long size);
```

在 `ReviewServiceImpl.java` 中实现这些方法（详细实现见完整代码仓库）。

---

## 前端代码

### 1. Rating API

创建文件: `/Users/bjsttlp324/Desktop/tools/frontend/web/src/api/rating.js`

```javascript
import request from './request'

/**
 * 提交评分
 */
export function submitRating(data) {
  return request({
    url: '/ratings',
    method: 'post',
    data
  })
}

/**
 * 获取工具评分统计
 */
export function getToolRatingStats(toolId) {
  return request({
    url: `/ratings/tool/${toolId}`,
    method: 'get'
  })
}

/**
 * 删除评分
 */
export function deleteRating(toolId) {
  return request({
    url: `/ratings/tool/${toolId}`,
    method: 'delete'
  })
}

/**
 * 检查是否已评分
 */
export function checkRating(toolId) {
  return request({
    url: `/ratings/tool/${toolId}/check`,
    method: 'get'
  })
}
```

### 2. 评分组件

创建文件: `/Users/bjsttlp324/Desktop/tools/frontend/web/src/components/RatingStars.vue`

```vue
<template>
  <div class="rating-stars">
    <div class="rating-display">
      <div class="stars">
        <span
          v-for="i in 5"
          :key="i"
          class="star"
          :class="{
            'filled': i <= (hoveredScore || userScore || 0),
            'interactive': interactive && isLoggedIn
          }"
          @click="handleClick(i)"
          @mouseenter="handleHover(i)"
          @mouseleave="handleHover(0)"
        >
          ★
        </span>
      </div>
      <div class="rating-info">
        <span class="average">{{ averageRating.toFixed(1) }}</span>
        <span class="count">({{ ratingCount }}人评分)</span>
      </div>
    </div>

    <div v-if="interactive && isLoggedIn && userScore" class="user-rating">
      你的评分: {{ userScore }}分
      <button @click="handleDelete" class="delete-btn">删除评分</button>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { submitRating, getToolRatingStats, deleteRating } from '@/api/rating'
import { useUserStore } from '@/stores/user'
import toast from '@/utils/toast'

const props = defineProps({
  toolId: {
    type: Number,
    required: true
  },
  interactive: {
    type: Boolean,
    default: false
  }
})

const emit = defineEmits(['rated', 'deleted'])

const userStore = useUserStore()
const isLoggedIn = computed(() => userStore.isLoggedIn)

const averageRating = ref(0)
const ratingCount = ref(0)
const userScore = ref(null)
const hoveredScore = ref(0)

// 加载评分统计
const loadRatingStats = async () => {
  try {
    const res = await getToolRatingStats(props.toolId)
    averageRating.value = res.data.averageRating || 0
    ratingCount.value = res.data.ratingCount || 0
    userScore.value = res.data.userScore || null
  } catch (error) {
    console.error('加载评分统计失败:', error)
  }
}

// 点击星星提交评分
const handleClick = async (score) => {
  if (!props.interactive || !isLoggedIn.value) return

  try {
    await submitRating({
      toolId: props.toolId,
      score
    })
    toast.success(userScore.value ? '评分已更新' : '评分成功')
    await loadRatingStats()
    emit('rated', score)
  } catch (error) {
    // 错误已在拦截器中处理
  }
}

// 鼠标悬停
const handleHover = (score) => {
  if (!props.interactive || !isLoggedIn.value) return
  hoveredScore.value = score
}

// 删除评分
const handleDelete = async () => {
  if (!confirm('确定要删除评分吗？')) return

  try {
    await deleteRating(props.toolId)
    toast.success('评分已删除')
    await loadRatingStats()
    emit('deleted')
  } catch (error) {
    // 错误已在拦截器中处理
  }
}

onMounted(() => {
  loadRatingStats()
})
</script>

<style scoped>
.rating-stars {
  padding: 20px 0;
}

.rating-display {
  display: flex;
  align-items: center;
  gap: 12px;
}

.stars {
  display: flex;
  gap: 4px;
}

.star {
  font-size: 24px;
  color: #ddd;
  transition: color 0.2s;
}

.star.filled {
  color: #ffb800;
}

.star.interactive {
  cursor: pointer;
}

.star.interactive:hover {
  color: #ffd700;
  transform: scale(1.1);
}

.rating-info {
  display: flex;
  align-items: baseline;
  gap: 8px;
}

.average {
  font-size: 20px;
  font-weight: bold;
  color: #333;
}

.count {
  font-size: 14px;
  color: #666;
}

.user-rating {
  margin-top: 12px;
  font-size: 14px;
  color: #666;
}

.delete-btn {
  margin-left: 8px;
  padding: 2px 8px;
  font-size: 12px;
  color: #f56c6c;
  background: none;
  border: 1px solid #f56c6c;
  border-radius: 4px;
  cursor: pointer;
}

.delete-btn:hover {
  background: #f56c6c;
  color: white;
}
</style>
```

### 3. 修改工具详情页

修改 `/Users/bjsttlp324/Desktop/tools/frontend/web/src/views/ToolDetail.vue`：

1. 导入评分组件：
```javascript
import RatingStars from '@/components/RatingStars.vue'
```

2. 注册组件：
```javascript
components: {
  RatingStars
}
```

3. 将"推荐人数"改为"收藏人数"，并添加评分组件：
```vue
<!-- 统计信息 -->
<div class="stats">
  <div class="stat-item">
    <span class="label">收藏人数</span>
    <span class="value">{{ tool.favoriteCount || 0 }}</span>
  </div>
  <div class="stat-item">
    <span class="label">评论数</span>
    <span class="value">{{ tool.reviewCount || 0 }}</span>
  </div>
</div>

<!-- 评分组件 -->
<RatingStars :tool-id="toolId" :interactive="true" @rated="handleRated" />
```

4. 添加评分后的处理方法：
```javascript
const handleRated = (score) => {
  console.log('用户评分:', score)
  // 可以选择重新加载工具数据以更新统计
  loadToolDetail()
}
```

### 4. 评论回复功能（简化版）

由于评论回复功能较复杂，建议分阶段实现。第一阶段先实现评分功能，确保可用后再实现评论回复。

完整的评论回复组件代码请参考项目仓库或后续实现。

---

## 测试步骤

### 后端测试

1. **执行数据库迁移**
```bash
mysql -uroot -p
source /Users/bjsttlp324/Desktop/tools/scripts/migrate-rating-review.sql
```

2. **重新编译并启动后端**
```bash
cd /Users/bjsttlp324/Desktop/tools/backend/tool-recommend-monolith
mvn clean compile
# 在IDEA中重启服务
```

3. **测试评分API**
```bash
# 1. 登录获取token
TOKEN="your_token_here"

# 2. 提交评分
curl -X POST http://localhost:8090/api/ratings \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"toolId": 1, "score": 5}'

# 3. 获取评分统计
curl http://localhost:8090/api/ratings/tool/1

# 4. 检查是否已评分
curl http://localhost:8090/api/ratings/tool/1/check \
  -H "Authorization: Bearer $TOKEN"
```

### 前端测试

1. 前端会自动热重载，直接在浏览器中测试
2. 进入工具详情页
3. 查看评分显示
4. 点击星星提交评分
5. 查看评分更新

---

## 注意事项

1. **数据库迁移** - 必须先执行数据库迁移
2. **Rating字段移除** - Review实体和DTO中的rating字段需要删除
3. **缓存清理** - 评分更新后需要清除相关缓存
4. **权限控制** - 评分需要登录，查看统计不需要登录
5. **并发控制** - 数据库唯一索引保证一个用户对一个工具只能有一条评分

---

## 后续优化

1. **评论回复功能** - 完整实现多级评论回复
2. **性能优化** - 添加Redis缓存评分统计
3. **实时更新** - WebSocket推送评分变化
4. **数据校验** - 更严格的输入校验
5. **分页优化** - 评论回复的分页加载

---

本文档包含核心功能的完整代码，按照文档创建文件即可快速实现评分功能！
